[{"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/29", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/29/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/29/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/29/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/29", "id": 2522180966, "node_id": "PR_kwDOJB_jns57SveO", "number": 29, "title": "Prevent keycloak requests", "user": {"login": "Tockra", "id": 1353859, "node_id": "MDQ6VXNlcjEzNTM4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1353859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tockra", "html_url": "https://github.com/Tockra", "followers_url": "https://api.github.com/users/Tockra/followers", "following_url": "https://api.github.com/users/Tockra/following{/other_user}", "gists_url": "https://api.github.com/users/Tockra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tockra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tockra/subscriptions", "organizations_url": "https://api.github.com/users/Tockra/orgs", "repos_url": "https://api.github.com/users/Tockra/repos", "events_url": "https://api.github.com/users/Tockra/events{/privacy}", "received_events_url": "https://api.github.com/users/Tockra/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2024-09-12T11:51:26Z", "updated_at": "2024-09-13T08:25:27Z", "closed_at": "2024-09-12T15:33:26Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/29", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/29", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/29.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/29.patch", "merged_at": "2024-09-12T15:33:26Z"}, "body": "#### Overview\r\nThis pull request addresses the issue of unnecessary OIDC discovery calls when token validation fails due to common errors like expired tokens or malformed tokens. The previous implementation triggered an OIDC request to Keycloak under various error conditions, which may not always be necessary.\r\n\r\n#### Previous Implementation\r\nThe middleware previously made OIDC requests for the following error conditions:\r\n<details>\r\n<summary>Error Conditions</summary>\r\n\r\nInvalidToken: Token doesn't have a valid JWT shape.\r\nInvalidSignature: Signature doesn't match.\r\nInvalidEcdsaKey: Secret is not a valid ECDSA key.\r\nInvalidRsaKey: Secret is not a valid RSA key.\r\nRsaFailedSigning: Failed signing with the given key.\r\nInvalidAlgorithmName: Algorithm name mismatch.\r\nInvalidKeyFormat: Key provided in an invalid format.\r\nMissingRequiredClaim: Required claim not present.\r\nExpiredSignature: Token's exp claim indicates expiration.\r\nInvalidIssuer: Token\u2019s iss claim does not match the expected issuer.\r\nInvalidAudience: Token\u2019s aud claim does not match expected values.\r\nInvalidSubject: Token\u2019s sub claim does not match expected values.\r\nImmatureSignature: Token\u2019s nbf claim is in the future.\r\nInvalidAlgorithm: Algorithm mismatch in header or key.\r\nMissingAlgorithm: Validation struct lacks algorithms.\r\nBase64: Error decoding base64 text.\r\nJson: Serialization/deserialization error.\r\nUtf8: Invalid UTF-8 text.\r\nCrypto: Unspecified crypto error.\r\n</details>\r\n\r\n#### Proposed Changes\r\nThe OIDC discovery should only occur for error conditions where it can potentially resolve the issue:\r\n\r\n- **InvalidRsaKey**: While rare, if this occurs, a valid key can be retrieved from Keycloak.\r\n- **InvalidEcdsaKey**: Added for completeness, though its relevance is uncertain.\r\n- **RsaFailedSigning**: May occur after a private key change in Keycloak. However, such changes are infrequent, and without rate limiting, this can lead to excessive requests to the Keycloak server through our Axum backend.\r\n\r\nBy refining these conditions, we reduce unnecessary load on both our system and the Keycloak server.", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/29/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/29/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/23", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/23/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/23/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/23/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/23", "id": 2321064733, "node_id": "PR_kwDOJB_jns5ww-3N", "number": 23, "title": "Allow to configure where the auth token will be passed", "user": {"login": "Tockra", "id": 1353859, "node_id": "MDQ6VXNlcjEzNTM4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1353859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tockra", "html_url": "https://github.com/Tockra", "followers_url": "https://api.github.com/users/Tockra/followers", "following_url": "https://api.github.com/users/Tockra/following{/other_user}", "gists_url": "https://api.github.com/users/Tockra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tockra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tockra/subscriptions", "organizations_url": "https://api.github.com/users/Tockra/orgs", "repos_url": "https://api.github.com/users/Tockra/repos", "events_url": "https://api.github.com/users/Tockra/events{/privacy}", "received_events_url": "https://api.github.com/users/Tockra/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2024-05-28T13:24:49Z", "updated_at": "2024-09-11T12:27:49Z", "closed_at": "2024-05-29T09:26:55Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/23", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/23", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/23.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/23.patch", "merged_at": "2024-05-29T09:26:55Z"}, "body": "### Description\r\n\r\nWhen using the WebSocket implementation in JavaScript, it can be challenging to add an Authorization header. For more context, see [solution 3 by kaqqao on Stack Overflow](https://stackoverflow.com/questions/4361173/http-headers-in-websockets-client-api).\r\n\r\nThis pull request introduces a way to configure the middleware, allowing you to specify where the JWT token should be expected. The token can be placed in the **HEADER** (default), **QUERY PARAM**, or **BOTH** (this solution first checks the header and if there is no token, it then checks the query param).\r\n\r\n### Changes\r\n\r\n- Added configuration options to the middleware for specifying the JWT token location:\r\n  - **HEADER** (default)\r\n  - **QUERY PARAM**\r\n  - **BOTH**\r\n\r\nThis enhancement provides flexibility in managing WebSocket authentication, making it easier to adapt to different client implementations and security requirements.\r\n\r\n", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/23/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/23/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/22", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/22/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/22/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/22/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/22", "id": 2233534298, "node_id": "PR_kwDOJB_jns5sItX9", "number": 22, "title": "Changed response codes in error case", "user": {"login": "Tockra", "id": 1353859, "node_id": "MDQ6VXNlcjEzNTM4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1353859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tockra", "html_url": "https://github.com/Tockra", "followers_url": "https://api.github.com/users/Tockra/followers", "following_url": "https://api.github.com/users/Tockra/following{/other_user}", "gists_url": "https://api.github.com/users/Tockra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tockra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tockra/subscriptions", "organizations_url": "https://api.github.com/users/Tockra/orgs", "repos_url": "https://api.github.com/users/Tockra/repos", "events_url": "https://api.github.com/users/Tockra/events{/privacy}", "received_events_url": "https://api.github.com/users/Tockra/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2024-04-09T14:08:10Z", "updated_at": "2024-05-28T13:18:37Z", "closed_at": "2024-05-28T13:17:56Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/22", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/22", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/22.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/22.patch", "merged_at": "2024-05-28T13:17:56Z"}, "body": "Attention this could break current implementations. \r\n\r\nAssociated with #21 \r\n\r\n401:\r\nMissingAuthorizationHeader, InvalidAuthorizationHeader, MissingBearerToken, NoDecodingKeys, InvalidToken, Decode \r\n\r\n403:\r\nInvalidToken, MissingExpectedRole", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/22/reactions", "total_count": 5, "+1": 4, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/22/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/19", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/19/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/19/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/19/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/19", "id": 2202244648, "node_id": "PR_kwDOJB_jns5qeZ2F", "number": 19, "title": "Cargo.toml: update reqwest dependency", "user": {"login": "dspicher", "id": 3934374, "node_id": "MDQ6VXNlcjM5MzQzNzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3934374?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dspicher", "html_url": "https://github.com/dspicher", "followers_url": "https://api.github.com/users/dspicher/followers", "following_url": "https://api.github.com/users/dspicher/following{/other_user}", "gists_url": "https://api.github.com/users/dspicher/gists{/gist_id}", "starred_url": "https://api.github.com/users/dspicher/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dspicher/subscriptions", "organizations_url": "https://api.github.com/users/dspicher/orgs", "repos_url": "https://api.github.com/users/dspicher/repos", "events_url": "https://api.github.com/users/dspicher/events{/privacy}", "received_events_url": "https://api.github.com/users/dspicher/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-03-22T11:04:26Z", "updated_at": "2024-03-24T07:53:55Z", "closed_at": "2024-03-24T07:53:54Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/19", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/19", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/19.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/19.patch", "merged_at": "2024-03-24T07:53:54Z"}, "body": "reqwest now takes care itself of activating the\r\noptional `serde_json` dependency under the already activated `json` feature [1].\r\n\r\n[1] https://github.com/seanmonstar/reqwest/blob/v0.12.0/CHANGELOG.md#v0120", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/19/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/19/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/18", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/18/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/18/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/18/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/18", "id": 2200094152, "node_id": "PR_kwDOJB_jns5qXBJQ", "number": 18, "title": "Allow token validation outside the axum middleware context", "user": {"login": "Tockra", "id": 1353859, "node_id": "MDQ6VXNlcjEzNTM4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1353859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tockra", "html_url": "https://github.com/Tockra", "followers_url": "https://api.github.com/users/Tockra/followers", "following_url": "https://api.github.com/users/Tockra/following{/other_user}", "gists_url": "https://api.github.com/users/Tockra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tockra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tockra/subscriptions", "organizations_url": "https://api.github.com/users/Tockra/orgs", "repos_url": "https://api.github.com/users/Tockra/repos", "events_url": "https://api.github.com/users/Tockra/events{/privacy}", "received_events_url": "https://api.github.com/users/Tockra/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2024-03-21T12:41:26Z", "updated_at": "2024-04-05T20:35:25Z", "closed_at": "2024-04-05T20:35:25Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/18", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/18", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/18.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/18.patch", "merged_at": "2024-04-05T20:35:25Z"}, "body": "I want to leverage Keycloak token validation in my Axum middleware and elsewhere in my application, like websocket authorization. Hence, I've centralized the validation logic in `decode.rs` and introduced a method in the Keycloak layer for easy JWT token validation with a string reference.\r\n\r\nRegarding two updates, I'm uncertain about:\r\n- Modifications to the `Extra` parameter in `KeycloakService` (`service.rs`, line 24).\r\n- The impact of changes to `KeycloakService` fields on performance or thread safety. I believe there shouldn't be any issues, but I admit I may not fully grasp all design decisions behind `axum-keycloak-auth`.\r\n\r\n\r\n\r\nChanges:\r\n- Implemented main validation logic in `decode.rs` (`extract_jwt_token` function).\r\n- Eliminated duplicate fields in `KeycloakService`, replacing them with a single instance of `KeycloakLayer` to streamline the code.\r\n- Introduced a token validation method in `KeycloakLayer` to enable token validation outside the Keycloak middleware, enhancing flexibility.", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/18/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/18/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/14", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/14/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/14/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/14/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/14", "id": 2142918319, "node_id": "PR_kwDOJB_jns5nUVZy", "number": 14, "title": "Fix typo in lib.rs -> \"puiblic\" to \"public\"", "user": {"login": "Tockra", "id": 1353859, "node_id": "MDQ6VXNlcjEzNTM4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1353859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tockra", "html_url": "https://github.com/Tockra", "followers_url": "https://api.github.com/users/Tockra/followers", "following_url": "https://api.github.com/users/Tockra/following{/other_user}", "gists_url": "https://api.github.com/users/Tockra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tockra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tockra/subscriptions", "organizations_url": "https://api.github.com/users/Tockra/orgs", "repos_url": "https://api.github.com/users/Tockra/repos", "events_url": "https://api.github.com/users/Tockra/events{/privacy}", "received_events_url": "https://api.github.com/users/Tockra/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-02-19T18:07:53Z", "updated_at": "2024-03-22T15:31:30Z", "closed_at": "2024-03-22T09:29:46Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/14", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/14", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/14.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/14.patch", "merged_at": "2024-03-22T09:29:45Z"}, "body": "- Fix typo in \"puiblic\" -> \"public\"\r\n\r\nSorry its a very small fix, but it triggered me :p", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/14/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/14/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/13", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/13/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/13/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/13/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/13", "id": 2116559369, "node_id": "PR_kwDOJB_jns5l612I", "number": 13, "title": "Cargo.toml: allow users to specify tls implementation", "user": {"login": "dspicher", "id": 3934374, "node_id": "MDQ6VXNlcjM5MzQzNzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3934374?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dspicher", "html_url": "https://github.com/dspicher", "followers_url": "https://api.github.com/users/dspicher/followers", "following_url": "https://api.github.com/users/dspicher/following{/other_user}", "gists_url": "https://api.github.com/users/dspicher/gists{/gist_id}", "starred_url": "https://api.github.com/users/dspicher/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dspicher/subscriptions", "organizations_url": "https://api.github.com/users/dspicher/orgs", "repos_url": "https://api.github.com/users/dspicher/repos", "events_url": "https://api.github.com/users/dspicher/events{/privacy}", "received_events_url": "https://api.github.com/users/dspicher/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2024-02-03T16:10:30Z", "updated_at": "2024-03-24T07:53:53Z", "closed_at": "2024-03-24T07:53:53Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/13", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/13", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/13.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/13.patch", "merged_at": "2024-03-24T07:53:53Z"}, "body": "We allow the user to choose between the default\r\nnative-tls and rustls TLS implementations for the\r\nreqwest dependency. The default behaviour remains\r\nactivating the previously used, default native-tls implementation, thus not breaking any clients.\r\n\r\nCloses #11.", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/13/reactions", "total_count": 3, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/13/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/12", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/12/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/12/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/12/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/12", "id": 2116553233, "node_id": "PR_kwDOJB_jns5l60qp", "number": 12, "title": "oidc-discovery: allow user to specify retry strategy", "user": {"login": "dspicher", "id": 3934374, "node_id": "MDQ6VXNlcjM5MzQzNzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3934374?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dspicher", "html_url": "https://github.com/dspicher", "followers_url": "https://api.github.com/users/dspicher/followers", "following_url": "https://api.github.com/users/dspicher/following{/other_user}", "gists_url": "https://api.github.com/users/dspicher/gists{/gist_id}", "starred_url": "https://api.github.com/users/dspicher/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dspicher/subscriptions", "organizations_url": "https://api.github.com/users/dspicher/orgs", "repos_url": "https://api.github.com/users/dspicher/repos", "events_url": "https://api.github.com/users/dspicher/events{/privacy}", "received_events_url": "https://api.github.com/users/dspicher/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-02-03T15:53:51Z", "updated_at": "2024-03-22T09:05:34Z", "closed_at": "2024-03-22T09:05:33Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/12", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/12", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/12.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/12.patch", "merged_at": "2024-03-22T09:05:33Z"}, "body": "We set a default value that resolves to the\r\npreviously hardcoded behavior, thus not breaking\r\nany clients.\r\n\r\nCloses #10.", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/12/reactions", "total_count": 3, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/12/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/9", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/9/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/9/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/9/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/9", "id": 2112011300, "node_id": "PR_kwDOJB_jns5lrHX_", "number": 9, "title": "feat: allow custom extra fields for `KeycloakToken`", "user": {"login": "fMeow", "id": 16273287, "node_id": "MDQ6VXNlcjE2MjczMjg3", "avatar_url": "https://avatars.githubusercontent.com/u/16273287?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fMeow", "html_url": "https://github.com/fMeow", "followers_url": "https://api.github.com/users/fMeow/followers", "following_url": "https://api.github.com/users/fMeow/following{/other_user}", "gists_url": "https://api.github.com/users/fMeow/gists{/gist_id}", "starred_url": "https://api.github.com/users/fMeow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fMeow/subscriptions", "organizations_url": "https://api.github.com/users/fMeow/orgs", "repos_url": "https://api.github.com/users/fMeow/repos", "events_url": "https://api.github.com/users/fMeow/events{/privacy}", "received_events_url": "https://api.github.com/users/fMeow/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2024-02-01T09:33:06Z", "updated_at": "2024-02-02T15:27:01Z", "closed_at": "2024-02-02T15:27:01Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/9", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/9", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/9.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/9.patch", "merged_at": "2024-02-02T15:27:01Z"}, "body": "The should fix #7 and furthurmore provides ability to define custom jwt scopes/fields.\r\n\r\nThe previous version hard coded first_name, last_name, email and etc into `KeycloakToken`. But these tokens can actually be turned off, especially when configured with external identity services. \r\n<img width=\"1917\" alt=\"image\" src=\"https://github.com/lpotthast/axum-keycloak-auth/assets/16273287/c8d1d45b-4038-474e-8970-3a1975cfbcdc\">\r\n\r\nThis PR add a generic parameter named `Extra` and passes it all the way through into KeycloakToken. Also, `ProfileAndEmail` is provided as the default `Extra` generic type, to meet the needs of most keycloak user that sticks with default usage (username/email/password authentication and never border to turned off profile or email scope).\r\n\r\nI bump the version in Cargo.toml to 0.5.0, since this commit introduces some breaking API changes. There is no more `token.full_name` but `token.extra.profile.preferred_username` when `Extra` is set to `ProfileAndEmail`, which is the default generic type.\r\n\r\nHere is an example to define and use custom jwt extra scopes:\r\n```rust\r\n// my tailored jwt scopes/fileds\r\n#[derive(Deserialize, Clone)]\r\nstruct MyExtra {\r\n    pub email: String,\r\n    pub preferred_username: String,\r\n    pub foo: String\r\n}\r\n\r\npub async fn protected(Extension(token): Extension<KeycloakToken<String, MyExtra>>) -> Response {\r\n    (StatusCode::OK,format!(\"Hello {}\", token.extra.foo)).into_response()\r\n}\r\n\r\nlet router = Router::new().route(\"/protected\", get(protected)).layer(\r\n        KeycloakAuthLayer::<String, MyExtra>::builder()\r\n            .instance(instance)\r\n            .passthrough_mode(PassthroughMode::Block)\r\n            .persist_raw_claims(false)\r\n            .expected_audiences(vec![])\r\n            .required_roles(vec![])\r\n            .build(),\r\n);\r\n```", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/9/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/9/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/8", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/8/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/8/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/8/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/8", "id": 2107119789, "node_id": "PR_kwDOJB_jns5laZIC", "number": 8, "title": "fix: decoding keys dead lock when OIDC running discovery", "user": {"login": "fMeow", "id": 16273287, "node_id": "MDQ6VXNlcjE2MjczMjg3", "avatar_url": "https://avatars.githubusercontent.com/u/16273287?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fMeow", "html_url": "https://github.com/fMeow", "followers_url": "https://api.github.com/users/fMeow/followers", "following_url": "https://api.github.com/users/fMeow/following{/other_user}", "gists_url": "https://api.github.com/users/fMeow/gists{/gist_id}", "starred_url": "https://api.github.com/users/fMeow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fMeow/subscriptions", "organizations_url": "https://api.github.com/users/fMeow/orgs", "repos_url": "https://api.github.com/users/fMeow/repos", "events_url": "https://api.github.com/users/fMeow/events{/privacy}", "received_events_url": "https://api.github.com/users/fMeow/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2024-01-30T07:18:22Z", "updated_at": "2024-01-30T07:54:08Z", "closed_at": "2024-01-30T07:54:08Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/8", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/8", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/8.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/8.patch", "merged_at": "2024-01-30T07:54:08Z"}, "body": "`decoding_keys()` contains a [read lock](https://github.com/lpotthast/axum-keycloak-auth/blob/f5bf7e023919c6ae20a657874bd43267c706d0d6/src/instance.rs#L138-L144) to `KeycloakAuthInstance discovory.value`, which cause dead lock when executing OIDC discovery.\r\n\r\nThis deadlock cause all services guarded by keyclock instance stuck forever. It can be easily reproduced with the example in docs, just by passing a token that triggers an OIDC discovery. We can try this token, which comes from a local dev keycloak server: \r\n```bash \r\ncurl http://localhost:8081/protected -H \"Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIteXh6aGRVbUZDTE1WcG9VN0cwdE41X0JWLUtua0RCTlgtNExENG1uQnBJIn0.eyJleHAiOjE3MDY2MDAxMTcsImlhdCI6MTcwNjU5OTgxNywiYXV0aF90aW1lIjoxNzA2NTk5ODExLCJqdGkiOiJjNmNjY2NmOS01NzA4LTQxNzktYjZhOS0yOTNiZDhmNTE3M2MiLCJpc3MiOiJodHRwOi8vMTI3LjAuMC4xOjgwODAvcmVhbG1zL3N2ZWx0ZS10ZXN0IiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjYyYzBkNDExLWY4YzktNDRiYi04MmUzLWU3YTBjNmRjNDg2OSIsInR5cCI6IkJlYXJlciIsImF6cCI6InN2ZWx0ZS10ZXN0Iiwibm9uY2UiOiI3YTc4Zjc4ZC0yNzIwLTQ4NTMtYmRlZi1jYWI0NGJhNDk4MTgiLCJzZXNzaW9uX3N0YXRlIjoiNjEzZTkwZjMtZjNjZS00MWY5LWE5ODgtMTIzNjg4M2M5Mjc3IiwiYWNyIjoiMCIsImFsbG93ZWQtb3JpZ2lucyI6WyIqIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImRlZmF1bHQtcm9sZXMtc3ZlbHRlLXRlc3QiLCJ1bWFfYXV0aG9yaXphdGlvbiIsImFsZ28iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6Im9wZW5pZCBwcm9maWxlIGVtYWlsIiwic2lkIjoiNjEzZTkwZjMtZjNjZS00MWY5LWE5ODgtMTIzNjg4M2M5Mjc3IiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJuYW1lIjoiRmlyc3QgTGFzdCIsInByZWZlcnJlZF91c2VybmFtZSI6InRlc3QiLCJnaXZlbl9uYW1lIjoiRmlyc3QiLCJmYW1pbHlfbmFtZSI6Ikxhc3QiLCJlbWFpbCI6InRlc3RAZnQudGVjaCJ9.TtEAnapPCWMR3u0rN8eFqGU-ecdJECzpJAnt9yIgNwUC3J-5g7VFpjpbNM6Ttzdmk_1s3kLc7Ai83U0P7YBjHodvsjexYJgiDStLfJT2L7GK1XBH2VS1G9_dBYJ-OchMHgWIKA94Bpi9rKWoP_b4YmWI511sCCSyZdbqa5lTdS57r5HkGZcDHll_1xjYvAoOMKF4_G0pL4pS9PVsDVD-fdshV1WNPaU60MpCJBFe2zaEx8lH_O0ExgRkkp5IA14eTanb0N5UI-fM843rSznre6udigpGHobk62oNKBaIriTlzTPDtzHr8rO1pAmRwDHMXYTcpPc0ukRghh4JHAzWNA\"\r\n``` \r\nCheers! We successfully perform a DoS attack with an invalid token that comes from an unknown server.\r\n\r\nThis PR limit the lifetime of decoding keys to the creation of raw_claims.\r\n\r\nHere is the code at fault:\r\n\r\n- [acquired read lock before discovering](https://github.com/lpotthast/axum-keycloak-auth/blob/f5bf7e023919c6ae20a657874bd43267c706d0d6/src/service.rs#L123C1-L146C11)\r\n```rust\r\n    let decoding_keys = kc_instance.decoding_keys().await; // <----- Here acquires a lock with a prolonged lifetime\r\n    let mut raw_claims = raw_token.decode(&header, expected_audiences, decoding_keys.iter());\r\n\r\n    if raw_claims.is_err() {\r\n        #[allow(clippy::unwrap_used)]\r\n        let retry = match raw_claims.as_ref().unwrap_err() {\r\n            AuthError::NoDecodingKeys | AuthError::Decode { source: _ } => {\r\n                if kc_instance.discovery.is_pending() {\r\n                    kc_instance.discovery.notified().await;\r\n                } else {\r\n                    kc_instance\r\n                        .discovery\r\n                        .dispatch(kc_instance.oidc_discovery_endpoint.clone()) // <---- write lock here\r\n                        .await\r\n                        .expect(\"No Join error\");\r\n                }\r\n                true\r\n            }\r\n            _ => false,\r\n        };\r\n// read lock is not dropped yet\r\n```\r\n- [acquiring value lock will dead lock when oidc discovering](https://github.com/lpotthast/axum-keycloak-auth/blob/f5bf7e023919c6ae20a657874bd43267c706d0d6/src/action.rs#L98)\r\n```rust\r\n    pub(crate) fn dispatch(&self, action_input: I) -> JoinHandle<()> {\r\n        let fut = (self.action_fn)(&action_input);\r\n        // ...\r\n        let value = self.value.clone();\r\n        // ...\r\n\r\n        tokio::spawn(async move {\r\n            *input.write().await = Some(action_input.clone());\r\n            // ...\r\n            *value.write().await = Some(new_value);\r\n            // ...\r\n        })\r\n    }\r\n}\r\n```", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/8/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/8/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/6", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/6/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/6/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/6/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/6", "id": 2090188258, "node_id": "PR_kwDOJB_jns5khxPq", "number": 6, "title": "OIDC discovery", "user": {"login": "lpotthast", "id": 9355833, "node_id": "MDQ6VXNlcjkzNTU4MzM=", "avatar_url": "https://avatars.githubusercontent.com/u/9355833?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lpotthast", "html_url": "https://github.com/lpotthast", "followers_url": "https://api.github.com/users/lpotthast/followers", "following_url": "https://api.github.com/users/lpotthast/following{/other_user}", "gists_url": "https://api.github.com/users/lpotthast/gists{/gist_id}", "starred_url": "https://api.github.com/users/lpotthast/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lpotthast/subscriptions", "organizations_url": "https://api.github.com/users/lpotthast/orgs", "repos_url": "https://api.github.com/users/lpotthast/repos", "events_url": "https://api.github.com/users/lpotthast/events{/privacy}", "received_events_url": "https://api.github.com/users/lpotthast/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-01-19T10:21:48Z", "updated_at": "2025-02-24T07:47:29Z", "closed_at": "2024-01-25T18:35:24Z", "author_association": "OWNER", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/6", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/6", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/6.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/6.patch", "merged_at": "2024-01-25T18:35:24Z"}, "body": "Closes https://github.com/lpotthast/axum-keycloak-auth/issues/5", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/6/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/6/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/3", "repository_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth", "labels_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/3/labels{/name}", "comments_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/3/comments", "events_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/3/events", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/3", "id": 2050851436, "node_id": "PR_kwDOJB_jns5ifMyD", "number": 3, "title": "Support a list of audiences", "user": {"login": "eboskma", "id": 346752, "node_id": "MDQ6VXNlcjM0Njc1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/346752?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eboskma", "html_url": "https://github.com/eboskma", "followers_url": "https://api.github.com/users/eboskma/followers", "following_url": "https://api.github.com/users/eboskma/following{/other_user}", "gists_url": "https://api.github.com/users/eboskma/gists{/gist_id}", "starred_url": "https://api.github.com/users/eboskma/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eboskma/subscriptions", "organizations_url": "https://api.github.com/users/eboskma/orgs", "repos_url": "https://api.github.com/users/eboskma/repos", "events_url": "https://api.github.com/users/eboskma/events{/privacy}", "received_events_url": "https://api.github.com/users/eboskma/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2023-12-20T15:57:44Z", "updated_at": "2023-12-27T10:25:44Z", "closed_at": "2023-12-27T10:25:43Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/pulls/3", "html_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/3", "diff_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/3.diff", "patch_url": "https://github.com/lpotthast/axum-keycloak-auth/pull/3.patch", "merged_at": "2023-12-27T10:25:43Z"}, "body": "According to [RFC7519: JSON Web Token (JWT) 4.1.3](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.3) the `aud` field of a JWT may be either a single string, or an array of strings.\r\n\r\nThis introduces a new dependency: `serde_with`. \r\n\r\nFixes #2 ", "reactions": {"url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/3/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lpotthast/axum-keycloak-auth/issues/3/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]