[{"url": "https://api.github.com/repos/rustls/ktls/issues/22", "repository_url": "https://api.github.com/repos/rustls/ktls", "labels_url": "https://api.github.com/repos/rustls/ktls/issues/22/labels{/name}", "comments_url": "https://api.github.com/repos/rustls/ktls/issues/22/comments", "events_url": "https://api.github.com/repos/rustls/ktls/issues/22/events", "html_url": "https://github.com/rustls/ktls/pull/22", "id": 1645448570, "node_id": "PR_kwDOIFhsvM5NJcOq", "number": 22, "title": "Proper kTLS handoff", "user": {"login": "fasterthanlime", "id": 7998310, "node_id": "MDQ6VXNlcjc5OTgzMTA=", "avatar_url": "https://avatars.githubusercontent.com/u/7998310?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fasterthanlime", "html_url": "https://github.com/fasterthanlime", "followers_url": "https://api.github.com/users/fasterthanlime/followers", "following_url": "https://api.github.com/users/fasterthanlime/following{/other_user}", "gists_url": "https://api.github.com/users/fasterthanlime/gists{/gist_id}", "starred_url": "https://api.github.com/users/fasterthanlime/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fasterthanlime/subscriptions", "organizations_url": "https://api.github.com/users/fasterthanlime/orgs", "repos_url": "https://api.github.com/users/fasterthanlime/repos", "events_url": "https://api.github.com/users/fasterthanlime/events{/privacy}", "received_events_url": "https://api.github.com/users/fasterthanlime/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-03-29T10:01:18Z", "updated_at": "2023-03-29T21:56:18Z", "closed_at": "2023-03-29T20:00:08Z", "author_association": "COLLABORATOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/rustls/ktls/pulls/22", "html_url": "https://github.com/rustls/ktls/pull/22", "diff_url": "https://github.com/rustls/ktls/pull/22.diff", "patch_url": "https://github.com/rustls/ktls/pull/22.patch", "merged_at": "2023-03-29T20:00:08Z"}, "body": "This branches off of #21 to aim to close #20.\r\n\r\nThis works by introducing a `CorkStream` abstraction that's aware of TLS message boundaries (works with both 1.2 and 1.3).\r\n\r\nAfter the rustls handshake is \"done\", we try to set up ktls - but rustls may have already read some encrypted data off of the socket, and buffered it internally. It might even have decrypted some messages.\r\n\r\nBy the time we attempt to set up kTLS, we might have a case where the TLS connection:\r\n\r\n  * A) Still has some decrypted messages it hasn't popped\r\n  * B) Still has some data in the deframer's internal buffer that is only a partial message\r\n\r\n\"Draining\" was supposed to fix \"A\", but couldn't fix \"B\" - that's where the \"message too long\" errors came from: kTLS was simply trying to decode a message starting from the middle (and the message length is just a u16).\r\n\r\nIdeally we'd stop rustls reading more bytes than is strictly needed for the handshake to finish, but that's hard in TLS 1.3 where the end of the handshake is encrypted and wrapped in \"ApplicationData\" records. Without integrating deeper into rustls/replacing rustls altogether, it's impossible to tell where the \"handshake/post-handshake encrypted exchanges\" ends and where the \"actual application data exchanges\" begins.\r\n\r\nSo, we let rustls however many ApplicationData messages it buffered while performing the handshake, but after it's \"returned from the future\" (accept for servers, connect for clients), by the time we try setting up kTLS, and before draining, we \"cork\" the `CorkStream`, which is TLS-framing-aware and knows to stop right after the current frame is finished.\r\n\r\nThe code has a bunch of unwrap/expects that shouldn't be there, so it still needs cleaning up, and I think there's still an edge case where rustls has part of a message but needs to await (EWOULDBLOCK) to get the rest of it - this would again break ktls setup, leaving a partial message undecrypted in rustls' internal buffers, and returning EMSGSIZE, EINVAL, or whichever other kTLS failure mode.", "reactions": {"url": "https://api.github.com/repos/rustls/ktls/issues/22/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rustls/ktls/issues/22/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/rustls/ktls/issues/19", "repository_url": "https://api.github.com/repos/rustls/ktls", "labels_url": "https://api.github.com/repos/rustls/ktls/issues/19/labels{/name}", "comments_url": "https://api.github.com/repos/rustls/ktls/issues/19/comments", "events_url": "https://api.github.com/repos/rustls/ktls/issues/19/events", "html_url": "https://github.com/rustls/ktls/pull/19", "id": 1636353282, "node_id": "PR_kwDOIFhsvM5MrH1R", "number": 19, "title": "Adds get_ref and get_mut functions to access wrapped IO", "user": {"login": "jeromegn", "id": 43325, "node_id": "MDQ6VXNlcjQzMzI1", "avatar_url": "https://avatars.githubusercontent.com/u/43325?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jeromegn", "html_url": "https://github.com/jeromegn", "followers_url": "https://api.github.com/users/jeromegn/followers", "following_url": "https://api.github.com/users/jeromegn/following{/other_user}", "gists_url": "https://api.github.com/users/jeromegn/gists{/gist_id}", "starred_url": "https://api.github.com/users/jeromegn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jeromegn/subscriptions", "organizations_url": "https://api.github.com/users/jeromegn/orgs", "repos_url": "https://api.github.com/users/jeromegn/repos", "events_url": "https://api.github.com/users/jeromegn/events{/privacy}", "received_events_url": "https://api.github.com/users/jeromegn/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2023-03-22T19:09:10Z", "updated_at": "2023-03-22T19:45:12Z", "closed_at": "2023-03-22T19:44:01Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/rustls/ktls/pulls/19", "html_url": "https://github.com/rustls/ktls/pull/19", "diff_url": "https://github.com/rustls/ktls/pull/19.diff", "patch_url": "https://github.com/rustls/ktls/pull/19.patch", "merged_at": "2023-03-22T19:44:01Z"}, "body": "This is useful for projects extending IO with traits, to implement them for more types by delegating", "reactions": {"url": "https://api.github.com/repos/rustls/ktls/issues/19/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rustls/ktls/issues/19/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]