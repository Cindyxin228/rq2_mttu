[{"url": "https://api.github.com/repos/webonnx/wonnx/issues/143", "repository_url": "https://api.github.com/repos/webonnx/wonnx", "labels_url": "https://api.github.com/repos/webonnx/wonnx/issues/143/labels{/name}", "comments_url": "https://api.github.com/repos/webonnx/wonnx/issues/143/comments", "events_url": "https://api.github.com/repos/webonnx/wonnx/issues/143/events", "html_url": "https://github.com/webonnx/wonnx/pull/143", "id": 1600130891, "node_id": "PR_kwDOF-1mxc5KxuQ1", "number": 143, "title": "perf: re-use intermediate value buffers", "user": {"login": "pixelspark", "id": 181337, "node_id": "MDQ6VXNlcjE4MTMzNw==", "avatar_url": "https://avatars.githubusercontent.com/u/181337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pixelspark", "html_url": "https://github.com/pixelspark", "followers_url": "https://api.github.com/users/pixelspark/followers", "following_url": "https://api.github.com/users/pixelspark/following{/other_user}", "gists_url": "https://api.github.com/users/pixelspark/gists{/gist_id}", "starred_url": "https://api.github.com/users/pixelspark/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pixelspark/subscriptions", "organizations_url": "https://api.github.com/users/pixelspark/orgs", "repos_url": "https://api.github.com/users/pixelspark/repos", "events_url": "https://api.github.com/users/pixelspark/events{/privacy}", "received_events_url": "https://api.github.com/users/pixelspark/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": true, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2023-02-26T17:14:50Z", "updated_at": "2023-03-04T10:03:59Z", "closed_at": "2023-03-04T09:27:02Z", "author_association": "COLLABORATOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/webonnx/wonnx/pulls/143", "html_url": "https://github.com/webonnx/wonnx/pull/143", "diff_url": "https://github.com/webonnx/wonnx/pull/143.diff", "patch_url": "https://github.com/webonnx/wonnx/pull/143.patch", "merged_at": "2023-03-04T09:27:02Z"}, "body": "This PR enabled re-usage of buffers for intermediate values (see #47) using a graph coloring algoritm. Basically, during the 'pre sequence' phase, a buffer manager keeps track of shared buffers and hands them out for use as intermediate value buffer, while keeping track of the lifetimes of each buffer. \r\n\r\nFor the included MNIST example (which is basically a linear graph of 8 nodes, optimized down to 6 nodes), we'd previously allocate 6 buffers for intermediate values. With this PR, only 2 are allocated (leading to a reduction of 1.46x in total buffer size). For the Squeeze example, the difference is more dramatic (only 3 buffers needed, 3.19x improvement in size). This is due to the fact that Squeeze too is relatively linear, but with multiple similar blocks of nodes repeated.\r\n\r\nNote, this PR should pass all tests but it currently fails with a BERT model:\r\n\r\n````\r\n2023-02-26T17:13:46Z ERROR wgpu::backend::direct] Handling wgpu errors as fatal by default\r\nthread 'main' panicked at 'wgpu error: Validation Error\r\n\r\nCaused by:\r\n    In a ComputePass\r\n      note: encoder = `<CommandBuffer-(0, 2, Metal)>`\r\n    In a dispatch command, indirect:false\r\n      note: compute pipeline = `bert/embeddings/add`\r\n    Attempted to use buffer with conflicting usages. Current usage STORAGE_READ and new usage STORAGE_READ_WRITE. STORAGE_READ_WRITE is an exclusive usage and cannot be used with any otherusages within the usage scope (renderpass or compute dispatch).\r\n````\r\n\r\nWill look into this later.", "reactions": {"url": "https://api.github.com/repos/webonnx/wonnx/issues/143/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/webonnx/wonnx/issues/143/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/webonnx/wonnx/issues/141", "repository_url": "https://api.github.com/repos/webonnx/wonnx", "labels_url": "https://api.github.com/repos/webonnx/wonnx/issues/141/labels{/name}", "comments_url": "https://api.github.com/repos/webonnx/wonnx/issues/141/comments", "events_url": "https://api.github.com/repos/webonnx/wonnx/issues/141/events", "html_url": "https://github.com/webonnx/wonnx/pull/141", "id": 1575117890, "node_id": "PR_kwDOF-1mxc5JeRb9", "number": 141, "title": "feat: implement shape inference", "user": {"login": "pixelspark", "id": 181337, "node_id": "MDQ6VXNlcjE4MTMzNw==", "avatar_url": "https://avatars.githubusercontent.com/u/181337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pixelspark", "html_url": "https://github.com/pixelspark", "followers_url": "https://api.github.com/users/pixelspark/followers", "following_url": "https://api.github.com/users/pixelspark/following{/other_user}", "gists_url": "https://api.github.com/users/pixelspark/gists{/gist_id}", "starred_url": "https://api.github.com/users/pixelspark/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pixelspark/subscriptions", "organizations_url": "https://api.github.com/users/pixelspark/orgs", "repos_url": "https://api.github.com/users/pixelspark/repos", "events_url": "https://api.github.com/users/pixelspark/events{/privacy}", "received_events_url": "https://api.github.com/users/pixelspark/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": true, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-02-07T22:25:24Z", "updated_at": "2023-03-04T10:04:14Z", "closed_at": "2023-03-04T09:27:02Z", "author_association": "COLLABORATOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/webonnx/wonnx/pulls/141", "html_url": "https://github.com/webonnx/wonnx/pull/141", "diff_url": "https://github.com/webonnx/wonnx/pull/141.diff", "patch_url": "https://github.com/webonnx/wonnx/pull/141.patch", "merged_at": "2023-03-04T09:27:02Z"}, "body": "This implements a basic but useable/useful form of shape inference and constant folding. Current capabilities:\r\n\r\n* Replace parameterized dimension values with actual values provided by the user.\r\n* Infer shapes for intermediate values (node outputs) for the following ops: Sub, Pow, Add, Div, Mul, Identity, Sqrt, ReduceMean, Gather, Constant, Relu, MaxPool, Conv, AveragePool, Reshape, Concat, Unsqueeze, Cast, Squeeze, Shape, Slice, Range\r\n* Fold constants for any node that has constant inputs and is implemented in WONNX for inference.\r\n\r\nThis is a useful addition to WONNX for the following scenarios:\r\n\r\n* Users who want to use ONNX models that do not carry shape information and/or have dynamic shapes, and who do not or cannot use onnxsimplifier (or for when onnxsimplifier crashes... which it currently does on my MacBook depending on the weather)\r\n* Use cases where shapes are dependent on runtime input (i.e. sequence length, dynamic batch sizes).\r\n\r\nThe above is implemented in the `wonnx_preprocessing` crate and can be accessed programmatically as well as through the CLI tool. The CLI tool can also show a 'trace' (where does an output come from) in case inference fails. The expectation is that users will use the CLI to prepare models for running them using WONNX on the web. The core `wonnx` crate needed some minor modifications (mostly exposing certain internal utility functions to `wonnx_preprocessing`) but otherwise doesn't suffer complexity or size increase from this feature.\r\n\r\nCurrently a test is implemented that removes all shape information from a model, then performs shape inference, and then compares to the original shape information. This test passes for the models in the `data/models` directory.\r\n\r\nI am working to improve the shape inference engine to also be able to fully infer shapes for e.g. a BERT or MDeBERTa model. A difficulty is that certain ops have 'dynamic' shapes (i.e. the `Shape` operator's output shape depends on the input tensor contents), but also some nodes require shape information before they can be run (and we can precalculate their outputs). It is possible (by ONNX design unfortunately) that some models cannot be fully inferred at all.\r\n", "reactions": {"url": "https://api.github.com/repos/webonnx/wonnx/issues/141/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 1, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/webonnx/wonnx/issues/141/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/webonnx/wonnx/issues/139", "repository_url": "https://api.github.com/repos/webonnx/wonnx", "labels_url": "https://api.github.com/repos/webonnx/wonnx/issues/139/labels{/name}", "comments_url": "https://api.github.com/repos/webonnx/wonnx/issues/139/comments", "events_url": "https://api.github.com/repos/webonnx/wonnx/issues/139/events", "html_url": "https://github.com/webonnx/wonnx/pull/139", "id": 1557512446, "node_id": "PR_kwDOF-1mxc5IjvsH", "number": 139, "title": "operator `LRN` (Local Response Normalization)", "user": {"login": "CameronTofer", "id": 3507892, "node_id": "MDQ6VXNlcjM1MDc4OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3507892?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CameronTofer", "html_url": "https://github.com/CameronTofer", "followers_url": "https://api.github.com/users/CameronTofer/followers", "following_url": "https://api.github.com/users/CameronTofer/following{/other_user}", "gists_url": "https://api.github.com/users/CameronTofer/gists{/gist_id}", "starred_url": "https://api.github.com/users/CameronTofer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CameronTofer/subscriptions", "organizations_url": "https://api.github.com/users/CameronTofer/orgs", "repos_url": "https://api.github.com/users/CameronTofer/repos", "events_url": "https://api.github.com/users/CameronTofer/events{/privacy}", "received_events_url": "https://api.github.com/users/CameronTofer/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": true, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-01-26T01:48:45Z", "updated_at": "2023-02-11T18:08:53Z", "closed_at": "2023-02-11T18:08:53Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/webonnx/wonnx/pulls/139", "html_url": "https://github.com/webonnx/wonnx/pull/139", "diff_url": "https://github.com/webonnx/wonnx/pull/139.diff", "patch_url": "https://github.com/webonnx/wonnx/pull/139.patch", "merged_at": "2023-02-11T18:08:53Z"}, "body": "My attempt at a reference implementation of LRN (Local Response Normalization).", "reactions": {"url": "https://api.github.com/repos/webonnx/wonnx/issues/139/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/webonnx/wonnx/issues/139/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/webonnx/wonnx/issues/138", "repository_url": "https://api.github.com/repos/webonnx/wonnx", "labels_url": "https://api.github.com/repos/webonnx/wonnx/issues/138/labels{/name}", "comments_url": "https://api.github.com/repos/webonnx/wonnx/issues/138/comments", "events_url": "https://api.github.com/repos/webonnx/wonnx/issues/138/events", "html_url": "https://github.com/webonnx/wonnx/pull/138", "id": 1557408347, "node_id": "PR_kwDOF-1mxc5IjZvk", "number": 138, "title": "Improve `CompileError` message with unnamed nodes", "user": {"login": "SludgePhD", "id": 96552222, "node_id": "U_kgDOBcFFHg", "avatar_url": "https://avatars.githubusercontent.com/u/96552222?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SludgePhD", "html_url": "https://github.com/SludgePhD", "followers_url": "https://api.github.com/users/SludgePhD/followers", "following_url": "https://api.github.com/users/SludgePhD/following{/other_user}", "gists_url": "https://api.github.com/users/SludgePhD/gists{/gist_id}", "starred_url": "https://api.github.com/users/SludgePhD/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SludgePhD/subscriptions", "organizations_url": "https://api.github.com/users/SludgePhD/orgs", "repos_url": "https://api.github.com/users/SludgePhD/repos", "events_url": "https://api.github.com/users/SludgePhD/events{/privacy}", "received_events_url": "https://api.github.com/users/SludgePhD/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": true, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-01-25T23:32:15Z", "updated_at": "2023-01-26T19:27:26Z", "closed_at": "2023-01-26T07:09:24Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/webonnx/wonnx/pulls/138", "html_url": "https://github.com/webonnx/wonnx/pull/138", "diff_url": "https://github.com/webonnx/wonnx/pull/138.diff", "patch_url": "https://github.com/webonnx/wonnx/pull/138.patch", "merged_at": "2023-01-26T07:09:24Z"}, "body": "This way, the node type is mentioned if the node has no name, which can often pinpoint the specific node regardless", "reactions": {"url": "https://api.github.com/repos/webonnx/wonnx/issues/138/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/webonnx/wonnx/issues/138/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/webonnx/wonnx/issues/120", "repository_url": "https://api.github.com/repos/webonnx/wonnx", "labels_url": "https://api.github.com/repos/webonnx/wonnx/issues/120/labels{/name}", "comments_url": "https://api.github.com/repos/webonnx/wonnx/issues/120/comments", "events_url": "https://api.github.com/repos/webonnx/wonnx/issues/120/events", "html_url": "https://github.com/webonnx/wonnx/pull/120", "id": 1292316655, "node_id": "PR_kwDOF-1mxc46wQxw", "number": 120, "title": "Fix/readability", "user": {"login": "pixelspark", "id": 181337, "node_id": "MDQ6VXNlcjE4MTMzNw==", "avatar_url": "https://avatars.githubusercontent.com/u/181337?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pixelspark", "html_url": "https://github.com/pixelspark", "followers_url": "https://api.github.com/users/pixelspark/followers", "following_url": "https://api.github.com/users/pixelspark/following{/other_user}", "gists_url": "https://api.github.com/users/pixelspark/gists{/gist_id}", "starred_url": "https://api.github.com/users/pixelspark/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pixelspark/subscriptions", "organizations_url": "https://api.github.com/users/pixelspark/orgs", "repos_url": "https://api.github.com/users/pixelspark/repos", "events_url": "https://api.github.com/users/pixelspark/events{/privacy}", "received_events_url": "https://api.github.com/users/pixelspark/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": true, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2022-07-03T13:57:42Z", "updated_at": "2023-02-03T09:11:15Z", "closed_at": "2023-02-03T09:11:10Z", "author_association": "COLLABORATOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/webonnx/wonnx/pulls/120", "html_url": "https://github.com/webonnx/wonnx/pull/120", "diff_url": "https://github.com/webonnx/wonnx/pull/120.diff", "patch_url": "https://github.com/webonnx/wonnx/pull/120.patch", "merged_at": "2023-02-03T09:11:10Z"}, "body": "We need to track 'readable' state because wgpu does not allow us to map buffers for reading that are also mappable for writing. We currently do this by passing 'output needs to be readable' flag when traversing the IR DAG.\r\n\r\nThis PR fixes an issue where if the same node's outputs in the IR DAG are read by more than one node (where it needs to be readable for the 'second' node that reads the output but not for the first), the output buffer is not made readable (as the first node did not require it).\r\n\r\n", "reactions": {"url": "https://api.github.com/repos/webonnx/wonnx/issues/120/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/webonnx/wonnx/issues/120/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]