[{"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10", "repository_url": "https://api.github.com/repos/kristoferlund/ic-siwe", "labels_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10/labels{/name}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10/comments", "events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10/events", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/10", "id": 2418901559, "node_id": "PR_kwDOKh-RqM515du-", "number": 10, "title": "v0.1.0 - Security fixes, making nonce required", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-07-19T13:18:27Z", "updated_at": "2024-08-22T13:28:27Z", "closed_at": "2024-08-22T13:28:27Z", "author_association": "OWNER", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/10", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/10", "diff_url": "https://github.com/kristoferlund/ic-siwe/pull/10.diff", "patch_url": "https://github.com/kristoferlund/ic-siwe/pull/10.patch", "merged_at": "2024-08-22T13:28:27Z"}, "body": "**This is a breaking change release**\r\n\r\nThis PR focuses on improving the security and reliability of the SIWE (Sign-In with Ethereum) process by ensuring proper cleanup of SIWE messages, implementing nonce-based security measures, and validating signature expiration. These changes help prevent replay attacks and ensure that expired signatures are not accepted.\r\n\r\n## Key Changes\r\n- **Ensure Expired SIWE Messages Removal:** Added logic to remove SIWE messages on failed login attempts to prevent stale data retention.\r\n- **Nonce Generation for SIWE Messages:** Implemented nonce generation for SIWE messages to enhance security by preventing replay attacks.\r\n- **Signature Expiry Validation:** Added functionality to return an error if a signature has expired.\r\n\r\n## Detailed Changes\r\n\r\n### Commits\r\n1. **[6daf4563f95f4dc653cb717f053e45e2fed578b9](https://github.com/kristoferlund/ic-siwe/commit/6daf4563f95f4dc653cb717f053e45e2fed578b9):**\r\n   - Fix: Remove stored SIWE message on failed login attempts.\r\n2. **[0b1118b822201b5bb124cfc0bd505a3c9550e29a](https://github.com/kristoferlund/ic-siwe/commit/0b1118b822201b5bb124cfc0bd505a3c9550e29a):**\r\n   - Feature: Secure generated SIWE messages using a nonce.\r\n3. **[c4cd84dc3125408100e3f37a1138e4a4cd3b5c2d](https://github.com/kristoferlund/ic-siwe/commit/c4cd84dc3125408100e3f37a1138e4a4cd3b5c2d):**\r\n   - Fix: Return error if signature has expired.\r\n\r\n### Detailed Code Changes\r\n\r\n- **New Functionality:**\r\n  - Added `is_expired` function in `SignatureMap` to check if a signature has expired:\r\n    ```rust\r\n    pub fn is_expired(&self, now: u64, seed_hash: Hash, delegation_hash: Hash) -> bool {\r\n        let expiration = self\r\n            .expiration_queue\r\n            .iter()\r\n            .find(|e| e.seed_hash == seed_hash && e.delegation_hash == delegation_hash);\r\n        if let Some(expiration) = expiration {\r\n            return now > expiration.signature_expires_at;\r\n        }\r\n        false\r\n    }\r\n    ```\r\n  - Modified `login` function to remove SIWE message on failed login attempts:\r\n    ```rust\r\n    match recover_eth_address(&message_string, signature) {\r\n        Ok(recovered_address) => {\r\n            if recovered_address != address.as_str() {\r\n                siwe_messages.remove(address, nonce);\r\n                return Err(LoginError::AddressMismatch);\r\n            }\r\n        }\r\n        Err(e) => {\r\n            siwe_messages.remove(address, nonce);\r\n            return Err(LoginError::EthError(e));\r\n        }\r\n    };\r\n    ```\r\n\r\n- **Nonce Implementation:**\r\n  - Updated `prepare_login` to generate and include a nonce:\r\n    ```rust\r\n    pub fn prepare_login(address: &EthAddress) -> Result<(SiweMessage, String), EthError> {\r\n        let nonce = generate_nonce();\r\n        let message = SiweMessage::new(address, &nonce);\r\n        SIWE_MESSAGES.with_borrow_mut(|siwe_messages| {\r\n            siwe_messages.insert(message.clone(), address, &nonce);\r\n        });\r\n        Ok((message, nonce))\r\n    }\r\n    ```\r\n\r\n- **Signature Expiry Validation:**\r\n  - Added signature expiry validation in `witness` function:\r\n    ```rust\r\n    pub fn witness(\r\n        seed: Hash,\r\n        delegation_hash: Hash,\r\n    ) -> Result<HashTree, DelegationError> {\r\n        let seed_hash = hash::hash_bytes(seed);\r\n        if signature_map.is_expired(get_current_time(), seed_hash, delegation_hash) {\r\n            return Err(DelegationError::SignatureExpired);\r\n        }\r\n        let witness = signature_map\r\n            .witness(seed_hash, delegation_hash)\r\n            .ok_or(DelegationError::SignatureNotFound)?;\r\n        Ok(witness)\r\n    }\r\n    ```\r\n", "reactions": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/9", "repository_url": "https://api.github.com/repos/kristoferlund/ic-siwe", "labels_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/9/labels{/name}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/9/comments", "events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/9/events", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/9", "id": 2392653230, "node_id": "PR_kwDOKh-RqM50inbk", "number": 9, "title": "v0.0.7", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-07-05T13:51:40Z", "updated_at": "2024-07-05T13:51:53Z", "closed_at": "2024-07-05T13:51:49Z", "author_association": "OWNER", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/9", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/9", "diff_url": "https://github.com/kristoferlund/ic-siwe/pull/9.diff", "patch_url": "https://github.com/kristoferlund/ic-siwe/pull/9.patch", "merged_at": "2024-07-05T13:51:49Z"}, "body": "## ic_siwe\r\n\r\n### Changed\r\n\r\n- Updated dependencies: candid, ic-cdk, ic-cdk-timers\r\n\r\n## ic_siwe_provider\r\n\r\n### Changed\r\n\r\n- Updated dependencies: candid, ic-cdk, ic-stable-structures\r\n", "reactions": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/9/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/9/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/7", "repository_url": "https://api.github.com/repos/kristoferlund/ic-siwe", "labels_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/7/labels{/name}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/7/comments", "events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/7/events", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/7", "id": 2205517363, "node_id": "PR_kwDOKh-RqM5qpThh", "number": 7, "title": "v0.0.6", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-03-25T11:24:42Z", "updated_at": "2024-03-25T11:24:54Z", "closed_at": "2024-03-25T11:24:48Z", "author_association": "OWNER", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/7", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/7", "diff_url": "https://github.com/kristoferlund/ic-siwe/pull/7.diff", "patch_url": "https://github.com/kristoferlund/ic-siwe/pull/7.patch", "merged_at": "2024-03-25T11:24:48Z"}, "body": "Prepare v0.0.6 release.", "reactions": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/7/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/7/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/6", "repository_url": "https://api.github.com/repos/kristoferlund/ic-siwe", "labels_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/6/labels{/name}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/6/comments", "events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/6/events", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/6", "id": 2205495528, "node_id": "PR_kwDOKh-RqM5qpOtR", "number": 6, "title": "Add/runtime feature disable eth icp mapping", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-03-25T11:13:28Z", "updated_at": "2024-03-25T11:25:07Z", "closed_at": "2024-03-25T11:13:35Z", "author_association": "OWNER", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/6", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/6", "diff_url": "https://github.com/kristoferlund/ic-siwe/pull/6.diff", "patch_url": "https://github.com/kristoferlund/ic-siwe/pull/6.patch", "merged_at": "2024-03-25T11:13:35Z"}, "body": "Adds additional runtime feature settings to the provider canister.\r\n\r\n```rust\r\npub enum RuntimeFeature {\r\n    // Enabling this feature will include the app frontend URI as part of the identity seed.\r\n    IncludeUriInSeed,\r\n\r\n    // (NEW) Disable the mapping of Ethereum address to principal. This also disables canister endpoints `get_principal`.\r\n    DisableEthToPrincipalMapping,\r\n\r\n    // (NEW) Disable the mapping of principal to Ethereum address. This also disables canister endpoints `get_address` and `get_caller_address`.\r\n    DisablePrincipalToEthMapping,\r\n}\r\n```\r\n\r\nTo activate, add to deploy script or Makefile: \r\n\r\n```\r\n  runtime_features = opt vec { \\\r\n    variant { DisableEthToPrincipalMapping }; \\\r\n    variant { DisablePrincipalToEthMapping }; \\\r\n  }; \\\r\n```", "reactions": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/6/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/6/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/5", "repository_url": "https://api.github.com/repos/kristoferlund/ic-siwe", "labels_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/5/labels{/name}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/5/comments", "events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/5/events", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/5", "id": 2205302781, "node_id": "PR_kwDOKh-RqM5qokMs", "number": 5, "title": "Add/runtime feature uri", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2024-03-25T09:36:46Z", "updated_at": "2024-03-25T11:25:09Z", "closed_at": "2024-03-25T09:37:05Z", "author_association": "OWNER", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/5", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/5", "diff_url": "https://github.com/kristoferlund/ic-siwe/pull/5.diff", "patch_url": "https://github.com/kristoferlund/ic-siwe/pull/5.patch", "merged_at": "2024-03-25T09:37:05Z"}, "body": "Adds \"runtime features\" as a way to custiomize the behaviour of `ic-siwe`. First added feature is `IncludeUrlInSeed`.\r\n\r\n### `IncludeUriInSeed`\r\n\r\nDefault: `Not enabled`\r\n\r\nWhen enabled, the URI is included in the seed used to generate the principal. Defaults to `Not enabled`. Including the URI in the seed does not add any additional security in a scenario where `ic_siwe_provider` is deployed and configured to serve only one domain. However, if  the `ic_siwe` library is used in a custom canister, that delegates identities for more than one domain, it is recommended to enable this feature to ensure that the principal is unique for each domain.\r\n\r\n```bash\r\n  runtime_features = opt vec { \\\r\n    variant { IncludeUriInSeed } \\\r\n  }; \r\n```", "reactions": {"url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/5/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/5/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]