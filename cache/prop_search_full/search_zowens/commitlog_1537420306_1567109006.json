[{"url": "https://api.github.com/repos/zowens/commitlog/issues/12", "repository_url": "https://api.github.com/repos/zowens/commitlog", "labels_url": "https://api.github.com/repos/zowens/commitlog/issues/12/labels{/name}", "comments_url": "https://api.github.com/repos/zowens/commitlog/issues/12/comments", "events_url": "https://api.github.com/repos/zowens/commitlog/issues/12/events", "html_url": "https://github.com/zowens/commitlog/pull/12", "id": 482595552, "node_id": "MDExOlB1bGxSZXF1ZXN0MzA4ODM3ODE1", "number": 12, "title": "Fix #11 - Can't recover index with single message", "user": {"login": "Quantumplation", "id": 49870, "node_id": "MDQ6VXNlcjQ5ODcw", "avatar_url": "https://avatars.githubusercontent.com/u/49870?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Quantumplation", "html_url": "https://github.com/Quantumplation", "followers_url": "https://api.github.com/users/Quantumplation/followers", "following_url": "https://api.github.com/users/Quantumplation/following{/other_user}", "gists_url": "https://api.github.com/users/Quantumplation/gists{/gist_id}", "starred_url": "https://api.github.com/users/Quantumplation/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Quantumplation/subscriptions", "organizations_url": "https://api.github.com/users/Quantumplation/orgs", "repos_url": "https://api.github.com/users/Quantumplation/repos", "events_url": "https://api.github.com/users/Quantumplation/events{/privacy}", "received_events_url": "https://api.github.com/users/Quantumplation/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2019-08-20T01:09:05Z", "updated_at": "2019-08-24T20:27:23Z", "closed_at": "2019-08-24T20:27:23Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zowens/commitlog/pulls/12", "html_url": "https://github.com/zowens/commitlog/pull/12", "diff_url": "https://github.com/zowens/commitlog/pull/12.diff", "patch_url": "https://github.com/zowens/commitlog/pull/12.patch", "merged_at": "2019-08-24T20:27:23Z"}, "body": "If we were ever opening an existing index with\r\nexactly one message, that one message would get\r\nlost and not show up when reading back the logs.\r\n\r\nWhen starting up and opening an existing index,\r\nwe binary search to find the first \"empty slot\".\r\n\r\nWe did so by checking if rel_off was 0, assuming\r\nthis would never be the case.  If we ever had more\r\nthan one message in the index, this would work\r\nbecause we'd hit the second message before we\r\nchecked the first message.  However, if we had\r\nexactly one message in a segment, it would have a\r\nrel_off of 0, and so the index would thing the whole\r\nindex was empty and overwrite this message.\r\n\r\nInstead, we use the file_off, which (as the pre-\r\nexisting comment mentioned) we can assume to be nonzero\r\nbecause there is always at least one magic byte at the\r\nstart of a segment, and this correctly finds the first\r\nopen slot.\r\n\r\nFixes #11", "reactions": {"url": "https://api.github.com/repos/zowens/commitlog/issues/12/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zowens/commitlog/issues/12/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]