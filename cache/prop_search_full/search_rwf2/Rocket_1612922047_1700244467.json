[{"url": "https://api.github.com/repos/rwf2/Rocket/issues/1618", "repository_url": "https://api.github.com/repos/rwf2/Rocket", "labels_url": "https://api.github.com/repos/rwf2/Rocket/issues/1618/labels{/name}", "comments_url": "https://api.github.com/repos/rwf2/Rocket/issues/1618/comments", "events_url": "https://api.github.com/repos/rwf2/Rocket/issues/1618/events", "html_url": "https://github.com/rwf2/Rocket/pull/1618", "id": 868203138, "node_id": "MDExOlB1bGxSZXF1ZXN0NjIzNzY0ODc0", "number": 1618, "title": "Initialize synchronous database pools inside of `spawn_blocking`.", "user": {"login": "jebrosen", "id": 7102588, "node_id": "MDQ6VXNlcjcxMDI1ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/7102588?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jebrosen", "html_url": "https://github.com/jebrosen", "followers_url": "https://api.github.com/users/jebrosen/followers", "following_url": "https://api.github.com/users/jebrosen/following{/other_user}", "gists_url": "https://api.github.com/users/jebrosen/gists{/gist_id}", "starred_url": "https://api.github.com/users/jebrosen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jebrosen/subscriptions", "organizations_url": "https://api.github.com/users/jebrosen/orgs", "repos_url": "https://api.github.com/users/jebrosen/repos", "events_url": "https://api.github.com/users/jebrosen/events{/privacy}", "received_events_url": "https://api.github.com/users/jebrosen/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-04-26T21:05:59Z", "updated_at": "2021-04-28T03:56:14Z", "closed_at": "2021-04-28T02:32:38Z", "author_association": "COLLABORATOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/rwf2/Rocket/pulls/1618", "html_url": "https://github.com/rwf2/Rocket/pull/1618", "diff_url": "https://github.com/rwf2/Rocket/pull/1618.diff", "patch_url": "https://github.com/rwf2/Rocket/pull/1618.patch", "merged_at": "2021-04-28T02:32:38Z"}, "body": "One situation where this is noticeable is when initialization failure\r\nleads to `Drop`; unlike in a successful initialization, `postgres`\r\ndetects and panics when `Drop` is called from within asynchronous code.\r\nSeveral other database pools do not panic in this same situation, but\r\nwould still block the current thread.\r\n\r\nAlso sets the minimum version of `tokio` to 1.4 in `rocket_contrib`,\r\nwhich is the version where `Handle::block_on` (used in `Drop` impls) was\r\nintroduced.\r\n\r\nFixes #1610.\r\n\r\n---\r\n\r\nThis should be reviewed closely, since there have been several bugs and regressions in this area. The goal is thus:\r\n\r\nSynchronous database pool and connection usage, *including* creation, usage, and `Drop`, should always be done inside some kind of \"blocking-safe\" environment. Since #1375 databases use `spawn_blocking`; alternatives include `block_in_place` (risky) or a dedicated thread with message passing to communicate between the async and sync code (safer, but probably not better than the status quo in terms of complexity to implement maintain or troubleshoot and likely still pretty bad ergonomically).\r\n\r\nThis problem is now addressed by starting the database pool inside a `spawn_blocking` closure. Usage of the database pool (i.e. acquiring connections) was already wrapped, along with usage of the connections themselves. This leaves `Drop`, which was also already wrapped properly -- aside from a race condition between server shutdown and handlers that were still running, which was recently fixed in e1307dd.", "reactions": {"url": "https://api.github.com/repos/rwf2/Rocket/issues/1618/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rwf2/Rocket/issues/1618/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/rwf2/Rocket/issues/1528", "repository_url": "https://api.github.com/repos/rwf2/Rocket", "labels_url": "https://api.github.com/repos/rwf2/Rocket/issues/1528/labels{/name}", "comments_url": "https://api.github.com/repos/rwf2/Rocket/issues/1528/comments", "events_url": "https://api.github.com/repos/rwf2/Rocket/issues/1528/events", "html_url": "https://github.com/rwf2/Rocket/pull/1528", "id": 802421096, "node_id": "MDExOlB1bGxSZXF1ZXN0NTY4NTY3MDY0", "number": 1528, "title": "update 'postgres' to 0.19 in rocket_contrib", "user": {"login": "jebrosen", "id": 7102588, "node_id": "MDQ6VXNlcjcxMDI1ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/7102588?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jebrosen", "html_url": "https://github.com/jebrosen", "followers_url": "https://api.github.com/users/jebrosen/followers", "following_url": "https://api.github.com/users/jebrosen/following{/other_user}", "gists_url": "https://api.github.com/users/jebrosen/gists{/gist_id}", "starred_url": "https://api.github.com/users/jebrosen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jebrosen/subscriptions", "organizations_url": "https://api.github.com/users/jebrosen/orgs", "repos_url": "https://api.github.com/users/jebrosen/repos", "events_url": "https://api.github.com/users/jebrosen/events{/privacy}", "received_events_url": "https://api.github.com/users/jebrosen/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-02-05T19:33:19Z", "updated_at": "2021-03-01T01:15:49Z", "closed_at": "2021-03-01T01:15:45Z", "author_association": "COLLABORATOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/rwf2/Rocket/pulls/1528", "html_url": "https://github.com/rwf2/Rocket/pull/1528", "diff_url": "https://github.com/rwf2/Rocket/pull/1528.diff", "patch_url": "https://github.com/rwf2/Rocket/pull/1528.patch", "merged_at": "2021-03-01T01:15:45Z"}, "body": "Closes #1527.", "reactions": {"url": "https://api.github.com/repos/rwf2/Rocket/issues/1528/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/rwf2/Rocket/issues/1528/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]