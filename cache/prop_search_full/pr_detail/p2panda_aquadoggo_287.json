{"url": "https://api.github.com/repos/p2panda/aquadoggo/pulls/287", "id": 1271487536, "node_id": "PR_kwDOEhY-tc5LyVww", "html_url": "https://github.com/p2panda/aquadoggo/pull/287", "diff_url": "https://github.com/p2panda/aquadoggo/pull/287.diff", "patch_url": "https://github.com/p2panda/aquadoggo/pull/287.patch", "issue_url": "https://api.github.com/repos/p2panda/aquadoggo/issues/287", "number": 287, "state": "closed", "locked": true, "title": "Use new version of `async-graphql` for dynamic schema generation", "user": {"login": "sandreae", "id": 24291662, "node_id": "MDQ6VXNlcjI0MjkxNjYy", "avatar_url": "https://avatars.githubusercontent.com/u/24291662?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sandreae", "html_url": "https://github.com/sandreae", "followers_url": "https://api.github.com/users/sandreae/followers", "following_url": "https://api.github.com/users/sandreae/following{/other_user}", "gists_url": "https://api.github.com/users/sandreae/gists{/gist_id}", "starred_url": "https://api.github.com/users/sandreae/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sandreae/subscriptions", "organizations_url": "https://api.github.com/users/sandreae/orgs", "repos_url": "https://api.github.com/users/sandreae/repos", "events_url": "https://api.github.com/users/sandreae/events{/privacy}", "received_events_url": "https://api.github.com/users/sandreae/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "body": "Use https://github.com/async-graphql/async-graphql and https://github.com/smmoosavi/dynamic-graphql to implement dynamic schema handling in our graphql api.\r\n\r\nThis took a little bit of time as I had to get to grips with the new `async-graphql` dynamic schema creation patterns, but I'm very happy with the result, it will be much more enjoyable (and quite quick) to expand our query api now with new features. \r\n\r\n## Design decisions\r\n- we use `async-graphql` to build all queries dynamically. It doesn't seem possible to combine \"statically\" defined queries with dynamic ones, so even `nextArgs` is defined using the dynamic API\r\n- all scalar and known types are defined using `dynamic-graphql` which offers macro wrappers for `async-graphql`, these are then registered on the root schema and can be referenced by name in dynamic queries where object types can be defined\r\n- the resolver pattern i adopted (i believe it's the recommended way) is to have each field perform a single db query to retrieve it's own value. The query bubbles up from it's root to tips, only resolving actual values in it's final step. For this to be efficient, we may want to make two changes:\r\n  1) implement a data loader which helps cache results for duplicate queries which occur in the same query tree (avoids N+1).\r\n  2) write a new SQL query for the field resolver which only targets the requested field. \r\n\r\n## Tasks\r\n\r\n- [x] remove old `graphql` module\r\n- [x] remove replication end points (we might want these back later, but for now they're gone)\r\n- [x] re-implement all functionality using above crates\r\n  - [x] scalar types\r\n  - [x] types \r\n    - [x] document meta \r\n    - [x] next args\r\n  - [x] build document fields schema\r\n  - [x] build document schema\r\n  - [x] build document query one\r\n  - [x] relations (single and lists)\r\n  - [x] build document query all \r\n  - [x] build next args\r\n  - [x] mutations: publish\r\n- [x] bring back all tests\r\n  - [x] make them pass.... \r\n- [x] ~add some more tests~ let's do this in next steps :face_in_clouds: we at least shouldn't have fewer tests than we did before!\r\n- [x] ~get `dynamic-schema` published or remove it from this PR~ it already was\r\n\r\n## Next steps\r\n- implement a data loader for efficient query caching\r\n- write field only SQL queries for field resolver (optional)\r\n\r\n## \ud83d\udccb Checklist\r\n\r\n- [x] Add tests that cover your changes\r\n- [x] Add this PR to the _Unreleased_ section in `CHANGELOG.md`\r\n- [x] Link this PR to any issues it closes\r\n- [x] New files contain a SPDX license header\r\n", "created_at": "2023-03-10T17:34:22Z", "updated_at": "2023-04-29T00:21:37Z", "closed_at": "2023-03-16T11:54:17Z", "merged_at": "2023-03-16T11:54:17Z", "merge_commit_sha": "cb411c0de0367f51b903268ad89fb61280c130d6", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/p2panda/aquadoggo/pulls/287/commits", "review_comments_url": "https://api.github.com/repos/p2panda/aquadoggo/pulls/287/comments", "review_comment_url": "https://api.github.com/repos/p2panda/aquadoggo/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/p2panda/aquadoggo/issues/287/comments", "statuses_url": "https://api.github.com/repos/p2panda/aquadoggo/statuses/34bc113e6118bb10981938f61097451ace330824", "head": {"label": "p2panda:async-graphql-dynamic-schema", "ref": "async-graphql-dynamic-schema", "sha": "34bc113e6118bb10981938f61097451ace330824", "user": {"login": "p2panda", "id": 49107945, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5MTA3OTQ1", "avatar_url": "https://avatars.githubusercontent.com/u/49107945?v=4", "gravatar_id": "", "url": "https://api.github.com/users/p2panda", "html_url": "https://github.com/p2panda", "followers_url": "https://api.github.com/users/p2panda/followers", "following_url": "https://api.github.com/users/p2panda/following{/other_user}", "gists_url": "https://api.github.com/users/p2panda/gists{/gist_id}", "starred_url": "https://api.github.com/users/p2panda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/p2panda/subscriptions", "organizations_url": "https://api.github.com/users/p2panda/orgs", "repos_url": "https://api.github.com/users/p2panda/repos", "events_url": "https://api.github.com/users/p2panda/events{/privacy}", "received_events_url": "https://api.github.com/users/p2panda/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "repo": {"id": 303447733, "node_id": "MDEwOlJlcG9zaXRvcnkzMDM0NDc3MzM=", "name": "aquadoggo", "full_name": "p2panda/aquadoggo", "private": false, "owner": {"login": "p2panda", "id": 49107945, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5MTA3OTQ1", "avatar_url": "https://avatars.githubusercontent.com/u/49107945?v=4", "gravatar_id": "", "url": "https://api.github.com/users/p2panda", "html_url": "https://github.com/p2panda", "followers_url": "https://api.github.com/users/p2panda/followers", "following_url": "https://api.github.com/users/p2panda/following{/other_user}", "gists_url": "https://api.github.com/users/p2panda/gists{/gist_id}", "starred_url": "https://api.github.com/users/p2panda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/p2panda/subscriptions", "organizations_url": "https://api.github.com/users/p2panda/orgs", "repos_url": "https://api.github.com/users/p2panda/repos", "events_url": "https://api.github.com/users/p2panda/events{/privacy}", "received_events_url": "https://api.github.com/users/p2panda/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/p2panda/aquadoggo", "description": "Node for the p2panda network handling validation, storage, aggregation and replication", "fork": false, "url": "https://api.github.com/repos/p2panda/aquadoggo", "forks_url": "https://api.github.com/repos/p2panda/aquadoggo/forks", "keys_url": "https://api.github.com/repos/p2panda/aquadoggo/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/p2panda/aquadoggo/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/p2panda/aquadoggo/teams", "hooks_url": "https://api.github.com/repos/p2panda/aquadoggo/hooks", "issue_events_url": "https://api.github.com/repos/p2panda/aquadoggo/issues/events{/number}", "events_url": "https://api.github.com/repos/p2panda/aquadoggo/events", "assignees_url": "https://api.github.com/repos/p2panda/aquadoggo/assignees{/user}", "branches_url": "https://api.github.com/repos/p2panda/aquadoggo/branches{/branch}", "tags_url": "https://api.github.com/repos/p2panda/aquadoggo/tags", "blobs_url": "https://api.github.com/repos/p2panda/aquadoggo/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/p2panda/aquadoggo/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/p2panda/aquadoggo/git/refs{/sha}", "trees_url": "https://api.github.com/repos/p2panda/aquadoggo/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/p2panda/aquadoggo/statuses/{sha}", "languages_url": "https://api.github.com/repos/p2panda/aquadoggo/languages", "stargazers_url": "https://api.github.com/repos/p2panda/aquadoggo/stargazers", "contributors_url": "https://api.github.com/repos/p2panda/aquadoggo/contributors", "subscribers_url": "https://api.github.com/repos/p2panda/aquadoggo/subscribers", "subscription_url": "https://api.github.com/repos/p2panda/aquadoggo/subscription", "commits_url": "https://api.github.com/repos/p2panda/aquadoggo/commits{/sha}", "git_commits_url": "https://api.github.com/repos/p2panda/aquadoggo/git/commits{/sha}", "comments_url": "https://api.github.com/repos/p2panda/aquadoggo/comments{/number}", "issue_comment_url": "https://api.github.com/repos/p2panda/aquadoggo/issues/comments{/number}", "contents_url": "https://api.github.com/repos/p2panda/aquadoggo/contents/{+path}", "compare_url": "https://api.github.com/repos/p2panda/aquadoggo/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/p2panda/aquadoggo/merges", "archive_url": "https://api.github.com/repos/p2panda/aquadoggo/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/p2panda/aquadoggo/downloads", "issues_url": "https://api.github.com/repos/p2panda/aquadoggo/issues{/number}", "pulls_url": "https://api.github.com/repos/p2panda/aquadoggo/pulls{/number}", "milestones_url": "https://api.github.com/repos/p2panda/aquadoggo/milestones{/number}", "notifications_url": "https://api.github.com/repos/p2panda/aquadoggo/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/p2panda/aquadoggo/labels{/name}", "releases_url": "https://api.github.com/repos/p2panda/aquadoggo/releases{/id}", "deployments_url": "https://api.github.com/repos/p2panda/aquadoggo/deployments", "created_at": "2020-10-12T16:19:07Z", "updated_at": "2025-12-25T20:59:06Z", "pushed_at": "2025-01-08T16:49:36Z", "git_url": "git://github.com/p2panda/aquadoggo.git", "ssh_url": "git@github.com:p2panda/aquadoggo.git", "clone_url": "https://github.com/p2panda/aquadoggo.git", "svn_url": "https://github.com/p2panda/aquadoggo", "homepage": "", "size": 1861, "stargazers_count": 78, "watchers_count": 78, "language": "Rust", "has_issues": true, "has_projects": false, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 5, "mirror_url": null, "archived": true, "disabled": false, "open_issues_count": 71, "license": {"key": "agpl-3.0", "name": "GNU Affero General Public License v3.0", "spdx_id": "AGPL-3.0", "url": "https://api.github.com/licenses/agpl-3.0", "node_id": "MDc6TGljZW5zZTE="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["graphql", "libp2p", "local-first", "node", "p2p"], "visibility": "public", "forks": 5, "open_issues": 71, "watchers": 78, "default_branch": "main"}}, "base": {"label": "p2panda:main", "ref": "main", "sha": "a792dac9fb41fbc5900b64da9598f02a692e2854", "user": {"login": "p2panda", "id": 49107945, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5MTA3OTQ1", "avatar_url": "https://avatars.githubusercontent.com/u/49107945?v=4", "gravatar_id": "", "url": "https://api.github.com/users/p2panda", "html_url": "https://github.com/p2panda", "followers_url": "https://api.github.com/users/p2panda/followers", "following_url": "https://api.github.com/users/p2panda/following{/other_user}", "gists_url": "https://api.github.com/users/p2panda/gists{/gist_id}", "starred_url": "https://api.github.com/users/p2panda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/p2panda/subscriptions", "organizations_url": "https://api.github.com/users/p2panda/orgs", "repos_url": "https://api.github.com/users/p2panda/repos", "events_url": "https://api.github.com/users/p2panda/events{/privacy}", "received_events_url": "https://api.github.com/users/p2panda/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "repo": {"id": 303447733, "node_id": "MDEwOlJlcG9zaXRvcnkzMDM0NDc3MzM=", "name": "aquadoggo", "full_name": "p2panda/aquadoggo", "private": false, "owner": {"login": "p2panda", "id": 49107945, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5MTA3OTQ1", "avatar_url": "https://avatars.githubusercontent.com/u/49107945?v=4", "gravatar_id": "", "url": "https://api.github.com/users/p2panda", "html_url": "https://github.com/p2panda", "followers_url": "https://api.github.com/users/p2panda/followers", "following_url": "https://api.github.com/users/p2panda/following{/other_user}", "gists_url": "https://api.github.com/users/p2panda/gists{/gist_id}", "starred_url": "https://api.github.com/users/p2panda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/p2panda/subscriptions", "organizations_url": "https://api.github.com/users/p2panda/orgs", "repos_url": "https://api.github.com/users/p2panda/repos", "events_url": "https://api.github.com/users/p2panda/events{/privacy}", "received_events_url": "https://api.github.com/users/p2panda/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/p2panda/aquadoggo", "description": "Node for the p2panda network handling validation, storage, aggregation and replication", "fork": false, "url": "https://api.github.com/repos/p2panda/aquadoggo", "forks_url": "https://api.github.com/repos/p2panda/aquadoggo/forks", "keys_url": "https://api.github.com/repos/p2panda/aquadoggo/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/p2panda/aquadoggo/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/p2panda/aquadoggo/teams", "hooks_url": "https://api.github.com/repos/p2panda/aquadoggo/hooks", "issue_events_url": "https://api.github.com/repos/p2panda/aquadoggo/issues/events{/number}", "events_url": "https://api.github.com/repos/p2panda/aquadoggo/events", "assignees_url": "https://api.github.com/repos/p2panda/aquadoggo/assignees{/user}", "branches_url": "https://api.github.com/repos/p2panda/aquadoggo/branches{/branch}", "tags_url": "https://api.github.com/repos/p2panda/aquadoggo/tags", "blobs_url": "https://api.github.com/repos/p2panda/aquadoggo/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/p2panda/aquadoggo/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/p2panda/aquadoggo/git/refs{/sha}", "trees_url": "https://api.github.com/repos/p2panda/aquadoggo/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/p2panda/aquadoggo/statuses/{sha}", "languages_url": "https://api.github.com/repos/p2panda/aquadoggo/languages", "stargazers_url": "https://api.github.com/repos/p2panda/aquadoggo/stargazers", "contributors_url": "https://api.github.com/repos/p2panda/aquadoggo/contributors", "subscribers_url": "https://api.github.com/repos/p2panda/aquadoggo/subscribers", "subscription_url": "https://api.github.com/repos/p2panda/aquadoggo/subscription", "commits_url": "https://api.github.com/repos/p2panda/aquadoggo/commits{/sha}", "git_commits_url": "https://api.github.com/repos/p2panda/aquadoggo/git/commits{/sha}", "comments_url": "https://api.github.com/repos/p2panda/aquadoggo/comments{/number}", "issue_comment_url": "https://api.github.com/repos/p2panda/aquadoggo/issues/comments{/number}", "contents_url": "https://api.github.com/repos/p2panda/aquadoggo/contents/{+path}", "compare_url": "https://api.github.com/repos/p2panda/aquadoggo/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/p2panda/aquadoggo/merges", "archive_url": "https://api.github.com/repos/p2panda/aquadoggo/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/p2panda/aquadoggo/downloads", "issues_url": "https://api.github.com/repos/p2panda/aquadoggo/issues{/number}", "pulls_url": "https://api.github.com/repos/p2panda/aquadoggo/pulls{/number}", "milestones_url": "https://api.github.com/repos/p2panda/aquadoggo/milestones{/number}", "notifications_url": "https://api.github.com/repos/p2panda/aquadoggo/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/p2panda/aquadoggo/labels{/name}", "releases_url": "https://api.github.com/repos/p2panda/aquadoggo/releases{/id}", "deployments_url": "https://api.github.com/repos/p2panda/aquadoggo/deployments", "created_at": "2020-10-12T16:19:07Z", "updated_at": "2025-12-25T20:59:06Z", "pushed_at": "2025-01-08T16:49:36Z", "git_url": "git://github.com/p2panda/aquadoggo.git", "ssh_url": "git@github.com:p2panda/aquadoggo.git", "clone_url": "https://github.com/p2panda/aquadoggo.git", "svn_url": "https://github.com/p2panda/aquadoggo", "homepage": "", "size": 1861, "stargazers_count": 78, "watchers_count": 78, "language": "Rust", "has_issues": true, "has_projects": false, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 5, "mirror_url": null, "archived": true, "disabled": false, "open_issues_count": 71, "license": {"key": "agpl-3.0", "name": "GNU Affero General Public License v3.0", "spdx_id": "AGPL-3.0", "url": "https://api.github.com/licenses/agpl-3.0", "node_id": "MDc6TGljZW5zZTE="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["graphql", "libp2p", "local-first", "node", "p2p"], "visibility": "public", "forks": 5, "open_issues": 71, "watchers": 78, "default_branch": "main"}}, "_links": {"self": {"href": "https://api.github.com/repos/p2panda/aquadoggo/pulls/287"}, "html": {"href": "https://github.com/p2panda/aquadoggo/pull/287"}, "issue": {"href": "https://api.github.com/repos/p2panda/aquadoggo/issues/287"}, "comments": {"href": "https://api.github.com/repos/p2panda/aquadoggo/issues/287/comments"}, "review_comments": {"href": "https://api.github.com/repos/p2panda/aquadoggo/pulls/287/comments"}, "review_comment": {"href": "https://api.github.com/repos/p2panda/aquadoggo/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/p2panda/aquadoggo/pulls/287/commits"}, "statuses": {"href": "https://api.github.com/repos/p2panda/aquadoggo/statuses/34bc113e6118bb10981938f61097451ace330824"}}, "author_association": "MEMBER", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "adzialocha", "id": 1822473, "node_id": "MDQ6VXNlcjE4MjI0NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822473?v=4", "gravatar_id": "", "url": "https://api.github.com/users/adzialocha", "html_url": "https://github.com/adzialocha", "followers_url": "https://api.github.com/users/adzialocha/followers", "following_url": "https://api.github.com/users/adzialocha/following{/other_user}", "gists_url": "https://api.github.com/users/adzialocha/gists{/gist_id}", "starred_url": "https://api.github.com/users/adzialocha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/adzialocha/subscriptions", "organizations_url": "https://api.github.com/users/adzialocha/orgs", "repos_url": "https://api.github.com/users/adzialocha/repos", "events_url": "https://api.github.com/users/adzialocha/events{/privacy}", "received_events_url": "https://api.github.com/users/adzialocha/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "comments": 3, "review_comments": 30, "maintainer_can_modify": false, "commits": 74, "additions": 1371, "deletions": 3116, "changed_files": 52}