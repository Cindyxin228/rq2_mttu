{"url": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/25", "id": 1304738146, "node_id": "PR_kwDOGFozc85NxLli", "html_url": "https://github.com/standard-ai/ya-gcp/pull/25", "diff_url": "https://github.com/standard-ai/ya-gcp/pull/25.diff", "patch_url": "https://github.com/standard-ai/ya-gcp/pull/25.patch", "issue_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues/25", "number": 25, "state": "closed", "locked": false, "title": "Update yup-oauth and add support for service account impersonation", "user": {"login": "matthew-healy", "id": 13350302, "node_id": "MDQ6VXNlcjEzMzUwMzAy", "avatar_url": "https://avatars.githubusercontent.com/u/13350302?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthew-healy", "html_url": "https://github.com/matthew-healy", "followers_url": "https://api.github.com/users/matthew-healy/followers", "following_url": "https://api.github.com/users/matthew-healy/following{/other_user}", "gists_url": "https://api.github.com/users/matthew-healy/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthew-healy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthew-healy/subscriptions", "organizations_url": "https://api.github.com/users/matthew-healy/orgs", "repos_url": "https://api.github.com/users/matthew-healy/repos", "events_url": "https://api.github.com/users/matthew-healy/events{/privacy}", "received_events_url": "https://api.github.com/users/matthew-healy/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "body": "**Note:** this PR was originally opened as #21, however since that was a PR from @xlambein's fork of this repo I had to move the branch over to this repo in order to push new changes. I'm reopening the PR exactly as before, but with this note & a commit which makes `tokio` a required dependency.\r\n\r\n# Original description\r\n\r\nThis PR's aim was to add service account impersonation as an authentication method, but in order to do this I had to update the version of `yup-oauth` to 8.1, which required quite a lot of changes.\r\n\r\nThe main one is that I removed the concept of `TokenSource` from this repository, for two reasons:\r\n\r\n- first, `yup-oauth` changed a bunch of things regarding how tokens work (a big one is that token generation can produce `None` now), making `TokenSource` difficult to adapt;\r\n- and second, because `TokenSource` was a bit redundant with `yup-oauth`'s own concept of [authenticators](https://docs.rs/yup-oauth2/latest/yup_oauth2/authenticator/index.html).\r\n\r\nSince version 6, the library has added many new authenticators, covering (I think) the use cases that `TokenSource` was covering.  Instead of a token source, `AuthGrpcService` now carries an authenticator and a list of scopes.\r\n\r\nUpdating `yup-oauth` also required replacing the `C: crate::Connect + Clone + Send + Sync + 'static` bounds with the following mouthful:\r\n\r\n```\r\nC: tower::Service<http::Uri> + Clone + Send + Sync + 'static,\r\nC::Response: hyper::client::connect::Connection\r\n    + tokio::io::AsyncRead\r\n    + tokio::io::AsyncWrite\r\n    + Send\r\n    + Unpin\r\n    + 'static,\r\nC::Future: Send + Unpin + 'static,\r\nC::Error: Into<Box<dyn std::error::Error + Send + Sync>>,\r\n```\r\n\r\nthe reason being that `hyper::Connect` is actually a private trait that cannot be implemented, and so `yup-oauth` changed at some point to the bounds above, which are equivalent, albeit annoying.", "created_at": "2023-04-06T13:12:13Z", "updated_at": "2023-04-06T16:13:40Z", "closed_at": "2023-04-06T16:13:40Z", "merged_at": "2023-04-06T16:13:39Z", "merge_commit_sha": "a8abca04df4ec2592275d96010326ea52c975c62", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/25/commits", "review_comments_url": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/25/comments", "review_comment_url": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues/25/comments", "statuses_url": "https://api.github.com/repos/standard-ai/ya-gcp/statuses/6b134d220a9794bf9a886f91477959954c7da901", "head": {"label": "standard-ai:xlambein/service-account-impersonation", "ref": "xlambein/service-account-impersonation", "sha": "6b134d220a9794bf9a886f91477959954c7da901", "user": {"login": "standard-ai", "id": 49494750, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5NDk0NzUw", "avatar_url": "https://avatars.githubusercontent.com/u/49494750?v=4", "gravatar_id": "", "url": "https://api.github.com/users/standard-ai", "html_url": "https://github.com/standard-ai", "followers_url": "https://api.github.com/users/standard-ai/followers", "following_url": "https://api.github.com/users/standard-ai/following{/other_user}", "gists_url": "https://api.github.com/users/standard-ai/gists{/gist_id}", "starred_url": "https://api.github.com/users/standard-ai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/standard-ai/subscriptions", "organizations_url": "https://api.github.com/users/standard-ai/orgs", "repos_url": "https://api.github.com/users/standard-ai/repos", "events_url": "https://api.github.com/users/standard-ai/events{/privacy}", "received_events_url": "https://api.github.com/users/standard-ai/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "repo": {"id": 408564595, "node_id": "MDEwOlJlcG9zaXRvcnk0MDg1NjQ1OTU=", "name": "ya-gcp", "full_name": "standard-ai/ya-gcp", "private": false, "owner": {"login": "standard-ai", "id": 49494750, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5NDk0NzUw", "avatar_url": "https://avatars.githubusercontent.com/u/49494750?v=4", "gravatar_id": "", "url": "https://api.github.com/users/standard-ai", "html_url": "https://github.com/standard-ai", "followers_url": "https://api.github.com/users/standard-ai/followers", "following_url": "https://api.github.com/users/standard-ai/following{/other_user}", "gists_url": "https://api.github.com/users/standard-ai/gists{/gist_id}", "starred_url": "https://api.github.com/users/standard-ai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/standard-ai/subscriptions", "organizations_url": "https://api.github.com/users/standard-ai/orgs", "repos_url": "https://api.github.com/users/standard-ai/repos", "events_url": "https://api.github.com/users/standard-ai/events{/privacy}", "received_events_url": "https://api.github.com/users/standard-ai/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/standard-ai/ya-gcp", "description": null, "fork": false, "url": "https://api.github.com/repos/standard-ai/ya-gcp", "forks_url": "https://api.github.com/repos/standard-ai/ya-gcp/forks", "keys_url": "https://api.github.com/repos/standard-ai/ya-gcp/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/standard-ai/ya-gcp/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/standard-ai/ya-gcp/teams", "hooks_url": "https://api.github.com/repos/standard-ai/ya-gcp/hooks", "issue_events_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues/events{/number}", "events_url": "https://api.github.com/repos/standard-ai/ya-gcp/events", "assignees_url": "https://api.github.com/repos/standard-ai/ya-gcp/assignees{/user}", "branches_url": "https://api.github.com/repos/standard-ai/ya-gcp/branches{/branch}", "tags_url": "https://api.github.com/repos/standard-ai/ya-gcp/tags", "blobs_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/refs{/sha}", "trees_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/standard-ai/ya-gcp/statuses/{sha}", "languages_url": "https://api.github.com/repos/standard-ai/ya-gcp/languages", "stargazers_url": "https://api.github.com/repos/standard-ai/ya-gcp/stargazers", "contributors_url": "https://api.github.com/repos/standard-ai/ya-gcp/contributors", "subscribers_url": "https://api.github.com/repos/standard-ai/ya-gcp/subscribers", "subscription_url": "https://api.github.com/repos/standard-ai/ya-gcp/subscription", "commits_url": "https://api.github.com/repos/standard-ai/ya-gcp/commits{/sha}", "git_commits_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/commits{/sha}", "comments_url": "https://api.github.com/repos/standard-ai/ya-gcp/comments{/number}", "issue_comment_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues/comments{/number}", "contents_url": "https://api.github.com/repos/standard-ai/ya-gcp/contents/{+path}", "compare_url": "https://api.github.com/repos/standard-ai/ya-gcp/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/standard-ai/ya-gcp/merges", "archive_url": "https://api.github.com/repos/standard-ai/ya-gcp/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/standard-ai/ya-gcp/downloads", "issues_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues{/number}", "pulls_url": "https://api.github.com/repos/standard-ai/ya-gcp/pulls{/number}", "milestones_url": "https://api.github.com/repos/standard-ai/ya-gcp/milestones{/number}", "notifications_url": "https://api.github.com/repos/standard-ai/ya-gcp/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/standard-ai/ya-gcp/labels{/name}", "releases_url": "https://api.github.com/repos/standard-ai/ya-gcp/releases{/id}", "deployments_url": "https://api.github.com/repos/standard-ai/ya-gcp/deployments", "created_at": "2021-09-20T18:52:51Z", "updated_at": "2025-06-13T22:27:46Z", "pushed_at": "2025-06-13T22:27:42Z", "git_url": "git://github.com/standard-ai/ya-gcp.git", "ssh_url": "git@github.com:standard-ai/ya-gcp.git", "clone_url": "https://github.com/standard-ai/ya-gcp.git", "svn_url": "https://github.com/standard-ai/ya-gcp", "homepage": null, "size": 373, "stargazers_count": 10, "watchers_count": 10, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 9, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 5, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 9, "open_issues": 5, "watchers": 10, "default_branch": "master"}}, "base": {"label": "standard-ai:master", "ref": "master", "sha": "4929c4361b16f783676b1ff8088a290cf82931b7", "user": {"login": "standard-ai", "id": 49494750, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5NDk0NzUw", "avatar_url": "https://avatars.githubusercontent.com/u/49494750?v=4", "gravatar_id": "", "url": "https://api.github.com/users/standard-ai", "html_url": "https://github.com/standard-ai", "followers_url": "https://api.github.com/users/standard-ai/followers", "following_url": "https://api.github.com/users/standard-ai/following{/other_user}", "gists_url": "https://api.github.com/users/standard-ai/gists{/gist_id}", "starred_url": "https://api.github.com/users/standard-ai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/standard-ai/subscriptions", "organizations_url": "https://api.github.com/users/standard-ai/orgs", "repos_url": "https://api.github.com/users/standard-ai/repos", "events_url": "https://api.github.com/users/standard-ai/events{/privacy}", "received_events_url": "https://api.github.com/users/standard-ai/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "repo": {"id": 408564595, "node_id": "MDEwOlJlcG9zaXRvcnk0MDg1NjQ1OTU=", "name": "ya-gcp", "full_name": "standard-ai/ya-gcp", "private": false, "owner": {"login": "standard-ai", "id": 49494750, "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ5NDk0NzUw", "avatar_url": "https://avatars.githubusercontent.com/u/49494750?v=4", "gravatar_id": "", "url": "https://api.github.com/users/standard-ai", "html_url": "https://github.com/standard-ai", "followers_url": "https://api.github.com/users/standard-ai/followers", "following_url": "https://api.github.com/users/standard-ai/following{/other_user}", "gists_url": "https://api.github.com/users/standard-ai/gists{/gist_id}", "starred_url": "https://api.github.com/users/standard-ai/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/standard-ai/subscriptions", "organizations_url": "https://api.github.com/users/standard-ai/orgs", "repos_url": "https://api.github.com/users/standard-ai/repos", "events_url": "https://api.github.com/users/standard-ai/events{/privacy}", "received_events_url": "https://api.github.com/users/standard-ai/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/standard-ai/ya-gcp", "description": null, "fork": false, "url": "https://api.github.com/repos/standard-ai/ya-gcp", "forks_url": "https://api.github.com/repos/standard-ai/ya-gcp/forks", "keys_url": "https://api.github.com/repos/standard-ai/ya-gcp/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/standard-ai/ya-gcp/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/standard-ai/ya-gcp/teams", "hooks_url": "https://api.github.com/repos/standard-ai/ya-gcp/hooks", "issue_events_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues/events{/number}", "events_url": "https://api.github.com/repos/standard-ai/ya-gcp/events", "assignees_url": "https://api.github.com/repos/standard-ai/ya-gcp/assignees{/user}", "branches_url": "https://api.github.com/repos/standard-ai/ya-gcp/branches{/branch}", "tags_url": "https://api.github.com/repos/standard-ai/ya-gcp/tags", "blobs_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/refs{/sha}", "trees_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/standard-ai/ya-gcp/statuses/{sha}", "languages_url": "https://api.github.com/repos/standard-ai/ya-gcp/languages", "stargazers_url": "https://api.github.com/repos/standard-ai/ya-gcp/stargazers", "contributors_url": "https://api.github.com/repos/standard-ai/ya-gcp/contributors", "subscribers_url": "https://api.github.com/repos/standard-ai/ya-gcp/subscribers", "subscription_url": "https://api.github.com/repos/standard-ai/ya-gcp/subscription", "commits_url": "https://api.github.com/repos/standard-ai/ya-gcp/commits{/sha}", "git_commits_url": "https://api.github.com/repos/standard-ai/ya-gcp/git/commits{/sha}", "comments_url": "https://api.github.com/repos/standard-ai/ya-gcp/comments{/number}", "issue_comment_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues/comments{/number}", "contents_url": "https://api.github.com/repos/standard-ai/ya-gcp/contents/{+path}", "compare_url": "https://api.github.com/repos/standard-ai/ya-gcp/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/standard-ai/ya-gcp/merges", "archive_url": "https://api.github.com/repos/standard-ai/ya-gcp/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/standard-ai/ya-gcp/downloads", "issues_url": "https://api.github.com/repos/standard-ai/ya-gcp/issues{/number}", "pulls_url": "https://api.github.com/repos/standard-ai/ya-gcp/pulls{/number}", "milestones_url": "https://api.github.com/repos/standard-ai/ya-gcp/milestones{/number}", "notifications_url": "https://api.github.com/repos/standard-ai/ya-gcp/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/standard-ai/ya-gcp/labels{/name}", "releases_url": "https://api.github.com/repos/standard-ai/ya-gcp/releases{/id}", "deployments_url": "https://api.github.com/repos/standard-ai/ya-gcp/deployments", "created_at": "2021-09-20T18:52:51Z", "updated_at": "2025-06-13T22:27:46Z", "pushed_at": "2025-06-13T22:27:42Z", "git_url": "git://github.com/standard-ai/ya-gcp.git", "ssh_url": "git@github.com:standard-ai/ya-gcp.git", "clone_url": "https://github.com/standard-ai/ya-gcp.git", "svn_url": "https://github.com/standard-ai/ya-gcp", "homepage": null, "size": 373, "stargazers_count": 10, "watchers_count": 10, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 9, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 5, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 9, "open_issues": 5, "watchers": 10, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/25"}, "html": {"href": "https://github.com/standard-ai/ya-gcp/pull/25"}, "issue": {"href": "https://api.github.com/repos/standard-ai/ya-gcp/issues/25"}, "comments": {"href": "https://api.github.com/repos/standard-ai/ya-gcp/issues/25/comments"}, "review_comments": {"href": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/25/comments"}, "review_comment": {"href": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/standard-ai/ya-gcp/pulls/25/commits"}, "statuses": {"href": "https://api.github.com/repos/standard-ai/ya-gcp/statuses/6b134d220a9794bf9a886f91477959954c7da901"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "rnarubin", "id": 4503172, "node_id": "MDQ6VXNlcjQ1MDMxNzI=", "avatar_url": "https://avatars.githubusercontent.com/u/4503172?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rnarubin", "html_url": "https://github.com/rnarubin", "followers_url": "https://api.github.com/users/rnarubin/followers", "following_url": "https://api.github.com/users/rnarubin/following{/other_user}", "gists_url": "https://api.github.com/users/rnarubin/gists{/gist_id}", "starred_url": "https://api.github.com/users/rnarubin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rnarubin/subscriptions", "organizations_url": "https://api.github.com/users/rnarubin/orgs", "repos_url": "https://api.github.com/users/rnarubin/repos", "events_url": "https://api.github.com/users/rnarubin/events{/privacy}", "received_events_url": "https://api.github.com/users/rnarubin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "comments": 0, "review_comments": 0, "maintainer_can_modify": false, "commits": 5, "additions": 357, "deletions": 259, "changed_files": 15}