{"url": "https://api.github.com/repos/kube-rs/kube/pulls/394", "id": 568933983, "node_id": "MDExOlB1bGxSZXF1ZXN0NTY4OTMzOTgz", "html_url": "https://github.com/kube-rs/kube/pull/394", "diff_url": "https://github.com/kube-rs/kube/pull/394.diff", "patch_url": "https://github.com/kube-rs/kube/pull/394.patch", "issue_url": "https://api.github.com/repos/kube-rs/kube/issues/394", "number": 394, "state": "closed", "locked": false, "title": "Replace reqwest with hyper + tower", "user": {"login": "kazk", "id": 639336, "node_id": "MDQ6VXNlcjYzOTMzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/639336?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kazk", "html_url": "https://github.com/kazk", "followers_url": "https://api.github.com/users/kazk/followers", "following_url": "https://api.github.com/users/kazk/following{/other_user}", "gists_url": "https://api.github.com/users/kazk/gists{/gist_id}", "starred_url": "https://api.github.com/users/kazk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kazk/subscriptions", "organizations_url": "https://api.github.com/users/kazk/orgs", "repos_url": "https://api.github.com/users/kazk/repos", "events_url": "https://api.github.com/users/kazk/events{/privacy}", "received_events_url": "https://api.github.com/users/kazk/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "body": "Replace `reqwest` with `hyper` (#362) and `tower` (#100). Supersedes #376.\r\n\r\n### Changes\r\n\r\n**`kube::Client` now uses `kube::Service` instead of `reqwest::Client`**\r\n\r\n```diff\r\n #[derive(Clone)]\r\n pub struct Client {\r\n-    cluster_url: reqwest::Url,\r\n-    default_ns: String,\r\n-    inner: reqwest::Client,\r\n-    config: Config,\r\n-    #[cfg(feature = \"ws\")]\r\n-    tls_connector: AsyncTlsConnector,\r\n+    inner: kube::Service,\r\n }\r\n```\r\n\r\n`kube::Service` struct is a `tower::Service<http::Request<hyper::Body>>`. For convenience, a service based on `hyper::Client` can be created from `kube::Config`, so `Client::try_default()` is still supported. We can add a feature for this to provide an option for a sans-io `Client` (#204).\r\n\r\nTo allow users to use their implementation when they need something not supported out of the box, I'm planning to change `Client::new(config: Config)` to `Client::new(service: Service)` (creating a `Client` from `Config` is still possible with `Client::new(config.try_into()?)`). This will also allow better testing.\r\n\r\n`kube::Service` uses [`tower::buffer::Buffer`](https://docs.rs/tower/0.4.4/tower/buffer/struct.Buffer.html), so it's cheap to clone (#17).\r\n\r\n**Upgrade to WebSocket connection with `hyper`**\r\n\r\nThe above change was possible because of this. No more separate client for WebSocket! The connection is upgraded with `hyper` and a `WebSocketStream` is created from the upgraded connection. All requests go through `kube::Service`.\r\n\r\n**Other Improvements**\r\n\r\n- Rewrote `Client::request_events` with `tokio_util::codec::FramedRead` (#379)\r\n- Refactored TLS related code. It's now all isolated in `kube/src/service/tls.rs`. `kube/src/config/auth.rs` has `HttpsConnector` for oauth requests and `kube/src/config/mod.rs` has some hack for macOS, but that's about it.\r\n- Replaced `oauth2` (GCP OAuth) module with [tame-oauth](https://github.com/EmbarkStudios/tame-oauth) and made it optional (`oauth` feature).\r\n- Refactored auth related code and moved them to `config::auth`.\r\n- Fixed a bug where refreshable token from `AuthProvider` was not refreshing.\r\n- Fixed panicking when loading `AuthInfo` with provider other than GCP (#238).\r\n\r\n### Breaking Changes\r\n\r\n- `oauth` is now opt-in\r\n- `gzip` should probably be opt-in for now because Kubernetes doesn't have it enabled by default yet and requires more dependencies. It's behind `APIResponseCompression` feature gate which is in `Beta` since 1.16. See <https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/>.\r\n- TODO Change `kube::Client::new(config: Config)` to `kube::Client::new(service: Service)`\r\n- Dropped proxy option. It should be possible by using a custom Service after the above change. TODO add example.\r\n\r\n---\r\n\r\nCloses #100, #238, #362, #379", "created_at": "2021-02-07T08:25:04Z", "updated_at": "2021-02-08T08:34:26Z", "closed_at": "2021-02-07T11:18:12Z", "merged_at": "2021-02-07T11:18:12Z", "merge_commit_sha": "5dc29b4498755dbee00b190df632072507968b6c", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/kube-rs/kube/pulls/394/commits", "review_comments_url": "https://api.github.com/repos/kube-rs/kube/pulls/394/comments", "review_comment_url": "https://api.github.com/repos/kube-rs/kube/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/kube-rs/kube/issues/394/comments", "statuses_url": "https://api.github.com/repos/kube-rs/kube/statuses/255c63def57c6fda5b71c7363dcc3dff13c6af4e", "head": {"label": "kazk:use-hyper-tower", "ref": "use-hyper-tower", "sha": "255c63def57c6fda5b71c7363dcc3dff13c6af4e", "user": {"login": "kazk", "id": 639336, "node_id": "MDQ6VXNlcjYzOTMzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/639336?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kazk", "html_url": "https://github.com/kazk", "followers_url": "https://api.github.com/users/kazk/followers", "following_url": "https://api.github.com/users/kazk/following{/other_user}", "gists_url": "https://api.github.com/users/kazk/gists{/gist_id}", "starred_url": "https://api.github.com/users/kazk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kazk/subscriptions", "organizations_url": "https://api.github.com/users/kazk/orgs", "repos_url": "https://api.github.com/users/kazk/repos", "events_url": "https://api.github.com/users/kazk/events{/privacy}", "received_events_url": "https://api.github.com/users/kazk/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "repo": {"id": 322496323, "node_id": "MDEwOlJlcG9zaXRvcnkzMjI0OTYzMjM=", "name": "kube-rs", "full_name": "kazk/kube-rs", "private": false, "owner": {"login": "kazk", "id": 639336, "node_id": "MDQ6VXNlcjYzOTMzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/639336?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kazk", "html_url": "https://github.com/kazk", "followers_url": "https://api.github.com/users/kazk/followers", "following_url": "https://api.github.com/users/kazk/following{/other_user}", "gists_url": "https://api.github.com/users/kazk/gists{/gist_id}", "starred_url": "https://api.github.com/users/kazk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kazk/subscriptions", "organizations_url": "https://api.github.com/users/kazk/orgs", "repos_url": "https://api.github.com/users/kazk/repos", "events_url": "https://api.github.com/users/kazk/events{/privacy}", "received_events_url": "https://api.github.com/users/kazk/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/kazk/kube-rs", "description": "kubernetes client and futures controller runtime", "fork": true, "url": "https://api.github.com/repos/kazk/kube-rs", "forks_url": "https://api.github.com/repos/kazk/kube-rs/forks", "keys_url": "https://api.github.com/repos/kazk/kube-rs/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/kazk/kube-rs/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/kazk/kube-rs/teams", "hooks_url": "https://api.github.com/repos/kazk/kube-rs/hooks", "issue_events_url": "https://api.github.com/repos/kazk/kube-rs/issues/events{/number}", "events_url": "https://api.github.com/repos/kazk/kube-rs/events", "assignees_url": "https://api.github.com/repos/kazk/kube-rs/assignees{/user}", "branches_url": "https://api.github.com/repos/kazk/kube-rs/branches{/branch}", "tags_url": "https://api.github.com/repos/kazk/kube-rs/tags", "blobs_url": "https://api.github.com/repos/kazk/kube-rs/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/kazk/kube-rs/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/kazk/kube-rs/git/refs{/sha}", "trees_url": "https://api.github.com/repos/kazk/kube-rs/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/kazk/kube-rs/statuses/{sha}", "languages_url": "https://api.github.com/repos/kazk/kube-rs/languages", "stargazers_url": "https://api.github.com/repos/kazk/kube-rs/stargazers", "contributors_url": "https://api.github.com/repos/kazk/kube-rs/contributors", "subscribers_url": "https://api.github.com/repos/kazk/kube-rs/subscribers", "subscription_url": "https://api.github.com/repos/kazk/kube-rs/subscription", "commits_url": "https://api.github.com/repos/kazk/kube-rs/commits{/sha}", "git_commits_url": "https://api.github.com/repos/kazk/kube-rs/git/commits{/sha}", "comments_url": "https://api.github.com/repos/kazk/kube-rs/comments{/number}", "issue_comment_url": "https://api.github.com/repos/kazk/kube-rs/issues/comments{/number}", "contents_url": "https://api.github.com/repos/kazk/kube-rs/contents/{+path}", "compare_url": "https://api.github.com/repos/kazk/kube-rs/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/kazk/kube-rs/merges", "archive_url": "https://api.github.com/repos/kazk/kube-rs/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/kazk/kube-rs/downloads", "issues_url": "https://api.github.com/repos/kazk/kube-rs/issues{/number}", "pulls_url": "https://api.github.com/repos/kazk/kube-rs/pulls{/number}", "milestones_url": "https://api.github.com/repos/kazk/kube-rs/milestones{/number}", "notifications_url": "https://api.github.com/repos/kazk/kube-rs/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/kazk/kube-rs/labels{/name}", "releases_url": "https://api.github.com/repos/kazk/kube-rs/releases{/id}", "deployments_url": "https://api.github.com/repos/kazk/kube-rs/deployments", "created_at": "2020-12-18T05:17:58Z", "updated_at": "2021-12-22T20:27:35Z", "pushed_at": "2023-03-06T02:12:50Z", "git_url": "git://github.com/kazk/kube-rs.git", "ssh_url": "git@github.com:kazk/kube-rs.git", "clone_url": "https://github.com/kazk/kube-rs.git", "svn_url": "https://github.com/kazk/kube-rs", "homepage": "https://docs.rs/kube/", "size": 3122, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": false, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 8, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 8, "watchers": 0, "default_branch": "main"}}, "base": {"label": "kube-rs:master", "ref": "master", "sha": "d450509554ef3f601a0e2ba90524b9fae43c1a7b", "user": {"login": "kube-rs", "id": 87537212, "node_id": "MDEyOk9yZ2FuaXphdGlvbjg3NTM3MjEy", "avatar_url": "https://avatars.githubusercontent.com/u/87537212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kube-rs", "html_url": "https://github.com/kube-rs", "followers_url": "https://api.github.com/users/kube-rs/followers", "following_url": "https://api.github.com/users/kube-rs/following{/other_user}", "gists_url": "https://api.github.com/users/kube-rs/gists{/gist_id}", "starred_url": "https://api.github.com/users/kube-rs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kube-rs/subscriptions", "organizations_url": "https://api.github.com/users/kube-rs/orgs", "repos_url": "https://api.github.com/users/kube-rs/repos", "events_url": "https://api.github.com/users/kube-rs/events{/privacy}", "received_events_url": "https://api.github.com/users/kube-rs/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "repo": {"id": 157133149, "node_id": "MDEwOlJlcG9zaXRvcnkxNTcxMzMxNDk=", "name": "kube", "full_name": "kube-rs/kube", "private": false, "owner": {"login": "kube-rs", "id": 87537212, "node_id": "MDEyOk9yZ2FuaXphdGlvbjg3NTM3MjEy", "avatar_url": "https://avatars.githubusercontent.com/u/87537212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kube-rs", "html_url": "https://github.com/kube-rs", "followers_url": "https://api.github.com/users/kube-rs/followers", "following_url": "https://api.github.com/users/kube-rs/following{/other_user}", "gists_url": "https://api.github.com/users/kube-rs/gists{/gist_id}", "starred_url": "https://api.github.com/users/kube-rs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kube-rs/subscriptions", "organizations_url": "https://api.github.com/users/kube-rs/orgs", "repos_url": "https://api.github.com/users/kube-rs/repos", "events_url": "https://api.github.com/users/kube-rs/events{/privacy}", "received_events_url": "https://api.github.com/users/kube-rs/received_events", "type": "Organization", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/kube-rs/kube", "description": "Rust Kubernetes client and controller runtime", "fork": false, "url": "https://api.github.com/repos/kube-rs/kube", "forks_url": "https://api.github.com/repos/kube-rs/kube/forks", "keys_url": "https://api.github.com/repos/kube-rs/kube/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/kube-rs/kube/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/kube-rs/kube/teams", "hooks_url": "https://api.github.com/repos/kube-rs/kube/hooks", "issue_events_url": "https://api.github.com/repos/kube-rs/kube/issues/events{/number}", "events_url": "https://api.github.com/repos/kube-rs/kube/events", "assignees_url": "https://api.github.com/repos/kube-rs/kube/assignees{/user}", "branches_url": "https://api.github.com/repos/kube-rs/kube/branches{/branch}", "tags_url": "https://api.github.com/repos/kube-rs/kube/tags", "blobs_url": "https://api.github.com/repos/kube-rs/kube/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/kube-rs/kube/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/kube-rs/kube/git/refs{/sha}", "trees_url": "https://api.github.com/repos/kube-rs/kube/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/kube-rs/kube/statuses/{sha}", "languages_url": "https://api.github.com/repos/kube-rs/kube/languages", "stargazers_url": "https://api.github.com/repos/kube-rs/kube/stargazers", "contributors_url": "https://api.github.com/repos/kube-rs/kube/contributors", "subscribers_url": "https://api.github.com/repos/kube-rs/kube/subscribers", "subscription_url": "https://api.github.com/repos/kube-rs/kube/subscription", "commits_url": "https://api.github.com/repos/kube-rs/kube/commits{/sha}", "git_commits_url": "https://api.github.com/repos/kube-rs/kube/git/commits{/sha}", "comments_url": "https://api.github.com/repos/kube-rs/kube/comments{/number}", "issue_comment_url": "https://api.github.com/repos/kube-rs/kube/issues/comments{/number}", "contents_url": "https://api.github.com/repos/kube-rs/kube/contents/{+path}", "compare_url": "https://api.github.com/repos/kube-rs/kube/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/kube-rs/kube/merges", "archive_url": "https://api.github.com/repos/kube-rs/kube/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/kube-rs/kube/downloads", "issues_url": "https://api.github.com/repos/kube-rs/kube/issues{/number}", "pulls_url": "https://api.github.com/repos/kube-rs/kube/pulls{/number}", "milestones_url": "https://api.github.com/repos/kube-rs/kube/milestones{/number}", "notifications_url": "https://api.github.com/repos/kube-rs/kube/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/kube-rs/kube/labels{/name}", "releases_url": "https://api.github.com/repos/kube-rs/kube/releases{/id}", "deployments_url": "https://api.github.com/repos/kube-rs/kube/deployments", "created_at": "2018-11-11T23:53:47Z", "updated_at": "2026-01-21T02:17:59Z", "pushed_at": "2026-01-20T15:54:01Z", "git_url": "git://github.com/kube-rs/kube.git", "ssh_url": "git@github.com:kube-rs/kube.git", "clone_url": "https://github.com/kube-rs/kube.git", "svn_url": "https://github.com/kube-rs/kube", "homepage": "https://kube.rs", "size": 4855, "stargazers_count": 3581, "watchers_count": 3581, "language": "Rust", "has_issues": true, "has_projects": false, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": true, "forks_count": 379, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 126, "license": {"key": "apache-2.0", "name": "Apache License 2.0", "spdx_id": "Apache-2.0", "url": "https://api.github.com/licenses/apache-2.0", "node_id": "MDc6TGljZW5zZTI="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": true, "topics": ["client", "kubernetes", "runtime", "rust"], "visibility": "public", "forks": 379, "open_issues": 126, "watchers": 3581, "default_branch": "main"}}, "_links": {"self": {"href": "https://api.github.com/repos/kube-rs/kube/pulls/394"}, "html": {"href": "https://github.com/kube-rs/kube/pull/394"}, "issue": {"href": "https://api.github.com/repos/kube-rs/kube/issues/394"}, "comments": {"href": "https://api.github.com/repos/kube-rs/kube/issues/394/comments"}, "review_comments": {"href": "https://api.github.com/repos/kube-rs/kube/pulls/394/comments"}, "review_comment": {"href": "https://api.github.com/repos/kube-rs/kube/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/kube-rs/kube/pulls/394/commits"}, "statuses": {"href": "https://api.github.com/repos/kube-rs/kube/statuses/255c63def57c6fda5b71c7363dcc3dff13c6af4e"}}, "author_association": "MEMBER", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": {"login": "clux", "id": 134092, "node_id": "MDQ6VXNlcjEzNDA5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/134092?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clux", "html_url": "https://github.com/clux", "followers_url": "https://api.github.com/users/clux/followers", "following_url": "https://api.github.com/users/clux/following{/other_user}", "gists_url": "https://api.github.com/users/clux/gists{/gist_id}", "starred_url": "https://api.github.com/users/clux/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clux/subscriptions", "organizations_url": "https://api.github.com/users/clux/orgs", "repos_url": "https://api.github.com/users/clux/repos", "events_url": "https://api.github.com/users/clux/events{/privacy}", "received_events_url": "https://api.github.com/users/clux/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "comments": 6, "review_comments": 9, "maintainer_can_modify": false, "commits": 31, "additions": 1235, "deletions": 1148, "changed_files": 24}