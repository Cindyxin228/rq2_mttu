{"url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/10", "id": 1977998270, "node_id": "PR_kwDOKh-RqM515du-", "html_url": "https://github.com/kristoferlund/ic-siwe/pull/10", "diff_url": "https://github.com/kristoferlund/ic-siwe/pull/10.diff", "patch_url": "https://github.com/kristoferlund/ic-siwe/pull/10.patch", "issue_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10", "number": 10, "state": "closed", "locked": false, "title": "v0.1.0 - Security fixes, making nonce required", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "body": "**This is a breaking change release**\r\n\r\nThis PR focuses on improving the security and reliability of the SIWE (Sign-In with Ethereum) process by ensuring proper cleanup of SIWE messages, implementing nonce-based security measures, and validating signature expiration. These changes help prevent replay attacks and ensure that expired signatures are not accepted.\r\n\r\n## Key Changes\r\n- **Ensure Expired SIWE Messages Removal:** Added logic to remove SIWE messages on failed login attempts to prevent stale data retention.\r\n- **Nonce Generation for SIWE Messages:** Implemented nonce generation for SIWE messages to enhance security by preventing replay attacks.\r\n- **Signature Expiry Validation:** Added functionality to return an error if a signature has expired.\r\n\r\n## Detailed Changes\r\n\r\n### Commits\r\n1. **[6daf4563f95f4dc653cb717f053e45e2fed578b9](https://github.com/kristoferlund/ic-siwe/commit/6daf4563f95f4dc653cb717f053e45e2fed578b9):**\r\n   - Fix: Remove stored SIWE message on failed login attempts.\r\n2. **[0b1118b822201b5bb124cfc0bd505a3c9550e29a](https://github.com/kristoferlund/ic-siwe/commit/0b1118b822201b5bb124cfc0bd505a3c9550e29a):**\r\n   - Feature: Secure generated SIWE messages using a nonce.\r\n3. **[c4cd84dc3125408100e3f37a1138e4a4cd3b5c2d](https://github.com/kristoferlund/ic-siwe/commit/c4cd84dc3125408100e3f37a1138e4a4cd3b5c2d):**\r\n   - Fix: Return error if signature has expired.\r\n\r\n### Detailed Code Changes\r\n\r\n- **New Functionality:**\r\n  - Added `is_expired` function in `SignatureMap` to check if a signature has expired:\r\n    ```rust\r\n    pub fn is_expired(&self, now: u64, seed_hash: Hash, delegation_hash: Hash) -> bool {\r\n        let expiration = self\r\n            .expiration_queue\r\n            .iter()\r\n            .find(|e| e.seed_hash == seed_hash && e.delegation_hash == delegation_hash);\r\n        if let Some(expiration) = expiration {\r\n            return now > expiration.signature_expires_at;\r\n        }\r\n        false\r\n    }\r\n    ```\r\n  - Modified `login` function to remove SIWE message on failed login attempts:\r\n    ```rust\r\n    match recover_eth_address(&message_string, signature) {\r\n        Ok(recovered_address) => {\r\n            if recovered_address != address.as_str() {\r\n                siwe_messages.remove(address, nonce);\r\n                return Err(LoginError::AddressMismatch);\r\n            }\r\n        }\r\n        Err(e) => {\r\n            siwe_messages.remove(address, nonce);\r\n            return Err(LoginError::EthError(e));\r\n        }\r\n    };\r\n    ```\r\n\r\n- **Nonce Implementation:**\r\n  - Updated `prepare_login` to generate and include a nonce:\r\n    ```rust\r\n    pub fn prepare_login(address: &EthAddress) -> Result<(SiweMessage, String), EthError> {\r\n        let nonce = generate_nonce();\r\n        let message = SiweMessage::new(address, &nonce);\r\n        SIWE_MESSAGES.with_borrow_mut(|siwe_messages| {\r\n            siwe_messages.insert(message.clone(), address, &nonce);\r\n        });\r\n        Ok((message, nonce))\r\n    }\r\n    ```\r\n\r\n- **Signature Expiry Validation:**\r\n  - Added signature expiry validation in `witness` function:\r\n    ```rust\r\n    pub fn witness(\r\n        seed: Hash,\r\n        delegation_hash: Hash,\r\n    ) -> Result<HashTree, DelegationError> {\r\n        let seed_hash = hash::hash_bytes(seed);\r\n        if signature_map.is_expired(get_current_time(), seed_hash, delegation_hash) {\r\n            return Err(DelegationError::SignatureExpired);\r\n        }\r\n        let witness = signature_map\r\n            .witness(seed_hash, delegation_hash)\r\n            .ok_or(DelegationError::SignatureNotFound)?;\r\n        Ok(witness)\r\n    }\r\n    ```\r\n", "created_at": "2024-07-19T13:18:27Z", "updated_at": "2024-08-22T13:28:27Z", "closed_at": "2024-08-22T13:28:27Z", "merged_at": "2024-08-22T13:28:27Z", "merge_commit_sha": "30e31e882c9a960781f8fb4b494cadad3beb65e0", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/10/commits", "review_comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/10/comments", "review_comment_url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10/comments", "statuses_url": "https://api.github.com/repos/kristoferlund/ic-siwe/statuses/02ecba1f848cd00ff8815fcd95857075d3f342bb", "head": {"label": "kristoferlund:dev", "ref": "dev", "sha": "02ecba1f848cd00ff8815fcd95857075d3f342bb", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "repo": {"id": 706711976, "node_id": "R_kgDOKh-RqA", "name": "ic-siwe", "full_name": "kristoferlund/ic-siwe", "private": false, "owner": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/kristoferlund/ic-siwe", "description": "SIWE, Sign in with Ethereum for ICP, the Internet Computer. Build cross chain Ethereum apps on ICP!", "fork": false, "url": "https://api.github.com/repos/kristoferlund/ic-siwe", "forks_url": "https://api.github.com/repos/kristoferlund/ic-siwe/forks", "keys_url": "https://api.github.com/repos/kristoferlund/ic-siwe/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/kristoferlund/ic-siwe/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/kristoferlund/ic-siwe/teams", "hooks_url": "https://api.github.com/repos/kristoferlund/ic-siwe/hooks", "issue_events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/events{/number}", "events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/events", "assignees_url": "https://api.github.com/repos/kristoferlund/ic-siwe/assignees{/user}", "branches_url": "https://api.github.com/repos/kristoferlund/ic-siwe/branches{/branch}", "tags_url": "https://api.github.com/repos/kristoferlund/ic-siwe/tags", "blobs_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/refs{/sha}", "trees_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/kristoferlund/ic-siwe/statuses/{sha}", "languages_url": "https://api.github.com/repos/kristoferlund/ic-siwe/languages", "stargazers_url": "https://api.github.com/repos/kristoferlund/ic-siwe/stargazers", "contributors_url": "https://api.github.com/repos/kristoferlund/ic-siwe/contributors", "subscribers_url": "https://api.github.com/repos/kristoferlund/ic-siwe/subscribers", "subscription_url": "https://api.github.com/repos/kristoferlund/ic-siwe/subscription", "commits_url": "https://api.github.com/repos/kristoferlund/ic-siwe/commits{/sha}", "git_commits_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/commits{/sha}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/comments{/number}", "issue_comment_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/comments{/number}", "contents_url": "https://api.github.com/repos/kristoferlund/ic-siwe/contents/{+path}", "compare_url": "https://api.github.com/repos/kristoferlund/ic-siwe/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/kristoferlund/ic-siwe/merges", "archive_url": "https://api.github.com/repos/kristoferlund/ic-siwe/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/kristoferlund/ic-siwe/downloads", "issues_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues{/number}", "pulls_url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls{/number}", "milestones_url": "https://api.github.com/repos/kristoferlund/ic-siwe/milestones{/number}", "notifications_url": "https://api.github.com/repos/kristoferlund/ic-siwe/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/kristoferlund/ic-siwe/labels{/name}", "releases_url": "https://api.github.com/repos/kristoferlund/ic-siwe/releases{/id}", "deployments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/deployments", "created_at": "2023-10-18T13:27:30Z", "updated_at": "2025-11-17T20:53:45Z", "pushed_at": "2025-09-12T12:07:07Z", "git_url": "git://github.com/kristoferlund/ic-siwe.git", "ssh_url": "git@github.com:kristoferlund/ic-siwe.git", "clone_url": "https://github.com/kristoferlund/ic-siwe.git", "svn_url": "https://github.com/kristoferlund/ic-siwe", "homepage": "https://shtr2-2iaaa-aaaal-qckva-cai.icp0.io", "size": 13227, "stargazers_count": 33, "watchers_count": 33, "language": "Rust", "has_issues": true, "has_projects": false, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 25, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 2, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["canister", "dfinity", "ethereum", "rust", "siwe"], "visibility": "public", "forks": 25, "open_issues": 2, "watchers": 33, "default_branch": "main"}}, "base": {"label": "kristoferlund:main", "ref": "main", "sha": "70720920a4ae1ef70405fcd00938768b816e69b8", "user": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "repo": {"id": 706711976, "node_id": "R_kgDOKh-RqA", "name": "ic-siwe", "full_name": "kristoferlund/ic-siwe", "private": false, "owner": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "html_url": "https://github.com/kristoferlund/ic-siwe", "description": "SIWE, Sign in with Ethereum for ICP, the Internet Computer. Build cross chain Ethereum apps on ICP!", "fork": false, "url": "https://api.github.com/repos/kristoferlund/ic-siwe", "forks_url": "https://api.github.com/repos/kristoferlund/ic-siwe/forks", "keys_url": "https://api.github.com/repos/kristoferlund/ic-siwe/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/kristoferlund/ic-siwe/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/kristoferlund/ic-siwe/teams", "hooks_url": "https://api.github.com/repos/kristoferlund/ic-siwe/hooks", "issue_events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/events{/number}", "events_url": "https://api.github.com/repos/kristoferlund/ic-siwe/events", "assignees_url": "https://api.github.com/repos/kristoferlund/ic-siwe/assignees{/user}", "branches_url": "https://api.github.com/repos/kristoferlund/ic-siwe/branches{/branch}", "tags_url": "https://api.github.com/repos/kristoferlund/ic-siwe/tags", "blobs_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/refs{/sha}", "trees_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/kristoferlund/ic-siwe/statuses/{sha}", "languages_url": "https://api.github.com/repos/kristoferlund/ic-siwe/languages", "stargazers_url": "https://api.github.com/repos/kristoferlund/ic-siwe/stargazers", "contributors_url": "https://api.github.com/repos/kristoferlund/ic-siwe/contributors", "subscribers_url": "https://api.github.com/repos/kristoferlund/ic-siwe/subscribers", "subscription_url": "https://api.github.com/repos/kristoferlund/ic-siwe/subscription", "commits_url": "https://api.github.com/repos/kristoferlund/ic-siwe/commits{/sha}", "git_commits_url": "https://api.github.com/repos/kristoferlund/ic-siwe/git/commits{/sha}", "comments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/comments{/number}", "issue_comment_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/comments{/number}", "contents_url": "https://api.github.com/repos/kristoferlund/ic-siwe/contents/{+path}", "compare_url": "https://api.github.com/repos/kristoferlund/ic-siwe/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/kristoferlund/ic-siwe/merges", "archive_url": "https://api.github.com/repos/kristoferlund/ic-siwe/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/kristoferlund/ic-siwe/downloads", "issues_url": "https://api.github.com/repos/kristoferlund/ic-siwe/issues{/number}", "pulls_url": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls{/number}", "milestones_url": "https://api.github.com/repos/kristoferlund/ic-siwe/milestones{/number}", "notifications_url": "https://api.github.com/repos/kristoferlund/ic-siwe/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/kristoferlund/ic-siwe/labels{/name}", "releases_url": "https://api.github.com/repos/kristoferlund/ic-siwe/releases{/id}", "deployments_url": "https://api.github.com/repos/kristoferlund/ic-siwe/deployments", "created_at": "2023-10-18T13:27:30Z", "updated_at": "2025-11-17T20:53:45Z", "pushed_at": "2025-09-12T12:07:07Z", "git_url": "git://github.com/kristoferlund/ic-siwe.git", "ssh_url": "git@github.com:kristoferlund/ic-siwe.git", "clone_url": "https://github.com/kristoferlund/ic-siwe.git", "svn_url": "https://github.com/kristoferlund/ic-siwe", "homepage": "https://shtr2-2iaaa-aaaal-qckva-cai.icp0.io", "size": 13227, "stargazers_count": 33, "watchers_count": 33, "language": "Rust", "has_issues": true, "has_projects": false, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 25, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 2, "license": {"key": "mit", "name": "MIT License", "spdx_id": "MIT", "url": "https://api.github.com/licenses/mit", "node_id": "MDc6TGljZW5zZTEz"}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["canister", "dfinity", "ethereum", "rust", "siwe"], "visibility": "public", "forks": 25, "open_issues": 2, "watchers": 33, "default_branch": "main"}}, "_links": {"self": {"href": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/10"}, "html": {"href": "https://github.com/kristoferlund/ic-siwe/pull/10"}, "issue": {"href": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10"}, "comments": {"href": "https://api.github.com/repos/kristoferlund/ic-siwe/issues/10/comments"}, "review_comments": {"href": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/10/comments"}, "review_comment": {"href": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/kristoferlund/ic-siwe/pulls/10/commits"}, "statuses": {"href": "https://api.github.com/repos/kristoferlund/ic-siwe/statuses/02ecba1f848cd00ff8815fcd95857075d3f342bb"}}, "author_association": "OWNER", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "kristoferlund", "id": 9698363, "node_id": "MDQ6VXNlcjk2OTgzNjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9698363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kristoferlund", "html_url": "https://github.com/kristoferlund", "followers_url": "https://api.github.com/users/kristoferlund/followers", "following_url": "https://api.github.com/users/kristoferlund/following{/other_user}", "gists_url": "https://api.github.com/users/kristoferlund/gists{/gist_id}", "starred_url": "https://api.github.com/users/kristoferlund/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kristoferlund/subscriptions", "organizations_url": "https://api.github.com/users/kristoferlund/orgs", "repos_url": "https://api.github.com/users/kristoferlund/repos", "events_url": "https://api.github.com/users/kristoferlund/events{/privacy}", "received_events_url": "https://api.github.com/users/kristoferlund/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "comments": 0, "review_comments": 0, "maintainer_can_modify": false, "commits": 12, "additions": 370, "deletions": 17367, "changed_files": 42}