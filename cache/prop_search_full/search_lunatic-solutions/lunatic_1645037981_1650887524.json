[{"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/101", "repository_url": "https://api.github.com/repos/lunatic-solutions/lunatic", "labels_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/101/labels{/name}", "comments_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/101/comments", "events_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/101/events", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/101", "id": 1186479021, "node_id": "PR_kwDOEVCc0c41UF4_", "number": 101, "title": "Rust testing support", "user": {"login": "bkolobara", "id": 593393, "node_id": "MDQ6VXNlcjU5MzM5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/593393?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bkolobara", "html_url": "https://github.com/bkolobara", "followers_url": "https://api.github.com/users/bkolobara/followers", "following_url": "https://api.github.com/users/bkolobara/following{/other_user}", "gists_url": "https://api.github.com/users/bkolobara/gists{/gist_id}", "starred_url": "https://api.github.com/users/bkolobara/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bkolobara/subscriptions", "organizations_url": "https://api.github.com/users/bkolobara/orgs", "repos_url": "https://api.github.com/users/bkolobara/repos", "events_url": "https://api.github.com/users/bkolobara/events{/privacy}", "received_events_url": "https://api.github.com/users/bkolobara/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-03-30T13:38:53Z", "updated_at": "2023-05-15T12:38:59Z", "closed_at": "2022-04-07T17:50:20Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/pulls/101", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/101", "diff_url": "https://github.com/lunatic-solutions/lunatic/pull/101.diff", "patch_url": "https://github.com/lunatic-solutions/lunatic/pull/101.patch", "merged_at": "2022-04-07T17:50:19Z"}, "body": "Closes #91\r\n\r\nThis PR adds the ability to the VM to behave the same way as rust would in case `lunatic` is used as a runner when running `cargo test`. This requires also that the `#[lunatic_test::test]` macro from the [lunatic-test crate](https://github.com/lunatic-solutions/rust-lib/tree/high-level-processes/lunatic-test) is used instead of rust's stdlib `#[test]`.\r\n\r\nDifferent from the #92 and #93 PRs, this one doesn't add an additional `lunatic test` command and is not meant to be a general purpose WebAssembly testing system. It's specifically made as a drop in replacement to provide a nice experience to developers that are already familiar with `cargo test`.\r\n\r\nThe idea is the following, if `lunatic` is set as the runner for wasm32 targets in `.cargo/config.toml` it will be used by `cargo` to prefix all the generated .wasm files. E.g. `cargo run` is going to generate a .wasm file from the main.rs entry point and run the app with `lunatic generated-file.wasm`. `cargo test` is going to generated a test .wasm file and invoke it with `lunatic generated-test-file.wasm`.\r\n\r\nBecause the `wasm32` target doesn't support panic catching and the default rust testing logic (`#[test]` macro) heavily depends on it, we can't use it. And [we can't use a different runner for `cargo test`](https://internals.rust-lang.org/t/cargo-config-toml-different-runner-for-tests/16342). So we are forced during runtime to detect when `cargo test` was invoked and load specifically annotated export functions. In practice this works ok, except some corner cases like `cargo test --example <example-name>`.\r\n\r\n### New `#[lunatic_test::test]` macro\r\n\r\nThe new macro is meant to be used as a drop-in replacement for `#[test]`. It should work together with existing test annotations, like `#[should_panic]` and `#[ignore]`. In case the build target is not `wasm32`, it will fall back to the stdlib `#[test]`. This allows us to easily switch between lunatic's and rust's testing engines by setting the `--target=\"\"` flag on `cargo test`. Here are some examples of it:\r\n\r\n* https://github.com/lunatic-solutions/rust-lib/blob/high-level-processes/lunatic-test/tests/panic.rs\r\n* https://github.com/lunatic-solutions/rust-lib/blob/high-level-processes/lunatic-test/tests/failing.rs\r\n\r\n### Supported `cargo test` features\r\n\r\n#### Flags:\r\n\r\n* [x] `--nocapture`\r\n* [x] `--show-output`\r\n* [x] `--ignored`\r\n* [ ] `--include-ignored`\r\n\r\n#### Output:\r\n\r\nRunning `cargo test` with `lunatic` as the runner should produce identical output as the standalone executable. There are some small differences in the color of the output and test function module prefixes. However, most of the info should be preserved, including the ability to show/hide output and automatically displaying output of failed tests.\r\n\r\n**~NOTE: Capturing output of spawned sub-processes is not supported at the moment.~** (now it is)\r\n\r\n#### Filters\r\n\r\nFiltering out tests with `cargo test <filter>` should work as expected. Filtering out integration tests with `cargo test --test <integration_test>` should work as expected.\r\n\r\n**NOTE: Running tests in examples with `cargo test --example <example_name>` is not supported**.\r\n\r\n#### Doc tests\r\n\r\nDocumentation tests can't be enabled for the `wasm32` target and are not supported.\r\n\r\n#### Multi-threaded execution\r\n\r\nAll tests are executed in parallel and there is currently no way of limiting the number of concurrent executions.\r\n\r\n### Next steps\r\n\r\nI'm satisfied with the result and think that the needs of most unite and integration tests should be cowered with this PR. I think that we should try to iron out all small differences between the test outputs in the future. Then set up a test-suite that will automatically run all combinations of flags and tests to compare lunatic's output to rust's. This would give us confidence that new releases of rust don't break the expected output format.", "reactions": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/101/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 1, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/101/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/100", "repository_url": "https://api.github.com/repos/lunatic-solutions/lunatic", "labels_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/100/labels{/name}", "comments_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/100/comments", "events_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/100/events", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/100", "id": 1171256860, "node_id": "PR_kwDOEVCc0c40i49h", "number": 100, "title": "Make `ProcessState` generic & split the remaining APIs into crates", "user": {"login": "bkolobara", "id": 593393, "node_id": "MDQ6VXNlcjU5MzM5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/593393?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bkolobara", "html_url": "https://github.com/bkolobara", "followers_url": "https://api.github.com/users/bkolobara/followers", "following_url": "https://api.github.com/users/bkolobara/following{/other_user}", "gists_url": "https://api.github.com/users/bkolobara/gists{/gist_id}", "starred_url": "https://api.github.com/users/bkolobara/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bkolobara/subscriptions", "organizations_url": "https://api.github.com/users/bkolobara/orgs", "repos_url": "https://api.github.com/users/bkolobara/repos", "events_url": "https://api.github.com/users/bkolobara/events{/privacy}", "received_events_url": "https://api.github.com/users/bkolobara/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-03-16T16:25:19Z", "updated_at": "2023-05-15T12:38:57Z", "closed_at": "2022-03-18T08:52:51Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/pulls/100", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/100", "diff_url": "https://github.com/lunatic-solutions/lunatic/pull/100.diff", "patch_url": "https://github.com/lunatic-solutions/lunatic/pull/100.patch", "merged_at": "2022-03-18T08:52:50Z"}, "body": "Closes #73\r\nCloses #87\r\nCloses #97\r\nCloses #98\r\n\r\nThis PR is addressing a few issues that depend on each other and could only be solved as one big change. It is also incompatible with the current releases of guest libraries and will require a PR for both, Rust and AssemblyScript, to make them compatible.\r\n\r\n## Crate split\r\n\r\nThis PR continues the work started in #96 and splits the remaining host functions into separate crates.\r\n\r\n## `ProcessState`\r\n\r\nIt also pulls most of the process related functionality into the `lunatic-process` crate. The main crate (`lunatic-runtime`) now just contains a definition of a \"default\" process with all the host functions enabled, but doesn't contain any functionality by itself.\r\n\r\n`ProcessState` is now a trait and embedders can provide their own state as long as they implement the necessary traits for all the host functions they intend to use. Host functions don't depend anymore on a concrete state, but instead require traits on a generic state type.\r\n\r\n## Wasm runtime abstraction\r\n\r\nThe Wasm runtime is also \"completely\" separated out and should be replaceable in the future. At the moment the `WasmtimeRuntime` is used everywhere, but if there is ever another Rust Wasm runtime that supports async host function it will be fairly easy to switch wasmtime out.\r\n\r\n## Environment removed\r\n\r\nThe `Environment` abstraction was removed in favour of a `Config` one. Instead of spawning processes into an environment with certain properties, they are spawned **with** a configuration. The `ProcessConfig` trait is bound to the `ProcessState` now. This allows host APIs to provide host functions that perform operations, but also some that can modify the process configuration. For example, the `lunatic-wasi-api` crate provides WASI host functions, but also functions to create specific configurations for child processes with custom environment variables, command line arguments and file access permissions.\r\n\r\nSimilar to the `ProcessState`, `ProcessConfig` is not a struct, but a trait and allows embedders to use the right config type for their needs.\r\n\r\n## Distributed lunatic\r\n\r\nTODO (@withtypes): I just commented out the implementation of distributed lunatic and the registry for now. It requires some rethinking. I think it makes sense just to rewrite a big part of it instead of trying to fit the old approach into the new architecture.\r\n\r\nHere are some of my ideas around it:\r\n- The `Node` should have a unique ID.\r\n- Resources, like processes, should switch from a `u64` ID to a tuple (node_id: u32, resource_id: u32). This will allow host functions that work with messages to right away know if they need to forward the message to another node or a local process.\r\n- The biggest issue currently is that the nodes can get out of sync because no consensus algorithm is used between them. I would for now just have a special coordinator node, that can be started for example with `lunatic --coordinator-node`. All other nodes connect to it and there is only one source of truth. Later we can just run multiple coordinator nodes that use a consensus algorithm between each other. The nodes would still connect to each other to avoid proxying messages through the coordinator. The coordinator would just be there to assign unique IDs, etc.", "reactions": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/100/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/100/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]