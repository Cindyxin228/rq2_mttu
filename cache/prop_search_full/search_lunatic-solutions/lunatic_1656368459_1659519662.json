[{"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/118", "repository_url": "https://api.github.com/repos/lunatic-solutions/lunatic", "labels_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/118/labels{/name}", "comments_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/118/comments", "events_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/118/events", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/118", "id": 1318705315, "node_id": "PR_kwDOEVCc0c48IvLe", "number": 118, "title": "Migrate lunatic-timer-api from async-std to tokio", "user": {"login": "MarkintoshZ", "id": 46978338, "node_id": "MDQ6VXNlcjQ2OTc4MzM4", "avatar_url": "https://avatars.githubusercontent.com/u/46978338?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MarkintoshZ", "html_url": "https://github.com/MarkintoshZ", "followers_url": "https://api.github.com/users/MarkintoshZ/followers", "following_url": "https://api.github.com/users/MarkintoshZ/following{/other_user}", "gists_url": "https://api.github.com/users/MarkintoshZ/gists{/gist_id}", "starred_url": "https://api.github.com/users/MarkintoshZ/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MarkintoshZ/subscriptions", "organizations_url": "https://api.github.com/users/MarkintoshZ/orgs", "repos_url": "https://api.github.com/users/MarkintoshZ/repos", "events_url": "https://api.github.com/users/MarkintoshZ/events{/privacy}", "received_events_url": "https://api.github.com/users/MarkintoshZ/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2022-07-26T20:13:55Z", "updated_at": "2022-07-26T20:25:04Z", "closed_at": "2022-07-26T20:25:03Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/pulls/118", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/118", "diff_url": "https://github.com/lunatic-solutions/lunatic/pull/118.diff", "patch_url": "https://github.com/lunatic-solutions/lunatic/pull/118.patch", "merged_at": "2022-07-26T20:25:03Z"}, "body": "Migrating the last part of the code base that still uses async-std to tokio.\r\n\r\n- [x] Build passed all tests in lunatic-rs.", "reactions": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/118/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/118/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/117", "repository_url": "https://api.github.com/repos/lunatic-solutions/lunatic", "labels_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/117/labels{/name}", "comments_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/117/comments", "events_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/117/events", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/117", "id": 1318545335, "node_id": "PR_kwDOEVCc0c48INbX", "number": 117, "title": "Refactor timeouts", "user": {"login": "bkolobara", "id": 593393, "node_id": "MDQ6VXNlcjU5MzM5Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/593393?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bkolobara", "html_url": "https://github.com/bkolobara", "followers_url": "https://api.github.com/users/bkolobara/followers", "following_url": "https://api.github.com/users/bkolobara/following{/other_user}", "gists_url": "https://api.github.com/users/bkolobara/gists{/gist_id}", "starred_url": "https://api.github.com/users/bkolobara/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bkolobara/subscriptions", "organizations_url": "https://api.github.com/users/bkolobara/orgs", "repos_url": "https://api.github.com/users/bkolobara/repos", "events_url": "https://api.github.com/users/bkolobara/events{/privacy}", "received_events_url": "https://api.github.com/users/bkolobara/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-07-26T17:21:41Z", "updated_at": "2023-05-15T12:39:06Z", "closed_at": "2022-07-26T17:30:51Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/pulls/117", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/117", "diff_url": "https://github.com/lunatic-solutions/lunatic/pull/117.diff", "patch_url": "https://github.com/lunatic-solutions/lunatic/pull/117.patch", "merged_at": "2022-07-26T17:30:51Z"}, "body": "Closes #95\r\n\r\n- Increases timeout type to `u64`\r\n- Changes \"no-timeout\" indicator to the value of `u64::MAX`\r\n- Uses the tokio `timeout` function for waiting, instead of a macro", "reactions": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/117/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/117/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/111", "repository_url": "https://api.github.com/repos/lunatic-solutions/lunatic", "labels_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/111/labels{/name}", "comments_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/111/comments", "events_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/111/events", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/111", "id": 1285392697, "node_id": "PR_kwDOEVCc0c46ZRKp", "number": 111, "title": "Distributed v2", "user": {"login": "withtypes", "id": 2822606, "node_id": "MDQ6VXNlcjI4MjI2MDY=", "avatar_url": "https://avatars.githubusercontent.com/u/2822606?v=4", "gravatar_id": "", "url": "https://api.github.com/users/withtypes", "html_url": "https://github.com/withtypes", "followers_url": "https://api.github.com/users/withtypes/followers", "following_url": "https://api.github.com/users/withtypes/following{/other_user}", "gists_url": "https://api.github.com/users/withtypes/gists{/gist_id}", "starred_url": "https://api.github.com/users/withtypes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/withtypes/subscriptions", "organizations_url": "https://api.github.com/users/withtypes/orgs", "repos_url": "https://api.github.com/users/withtypes/repos", "events_url": "https://api.github.com/users/withtypes/events{/privacy}", "received_events_url": "https://api.github.com/users/withtypes/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2022-06-27T07:48:37Z", "updated_at": "2023-05-15T12:39:00Z", "closed_at": "2022-07-14T13:43:38Z", "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/pulls/111", "html_url": "https://github.com/lunatic-solutions/lunatic/pull/111", "diff_url": "https://github.com/lunatic-solutions/lunatic/pull/111.diff", "patch_url": "https://github.com/lunatic-solutions/lunatic/pull/111.patch", "merged_at": "2022-07-14T13:43:38Z"}, "body": "New distributed implementation introduces the idea of control nodes. Control nodes keep information about lunatic nodes, Wasm modules, environments, and perform authentication. Lunatic nodes communicate directly after they register via control nodes.\r\nWe provide a simple implementation of a control node for now, but the idea is to have a distributed and persistent control nodes (backed by a distributed key-value database).\r\n\r\n## Architecture\r\n\r\nCode is kept in two crates: `lunatic-distributed` and `lunatic-distributed-api` (host functions for Wasm).\r\n\r\n<img src=\"https://user-images.githubusercontent.com/2822606/177097271-f23385ce-1233-4bea-972e-c482dafe7941.svg\" alt=\"\" width=\"300\" />\r\n\r\nThere are two changes in non-distributed lunatic:\r\n - addition of environments: they act as a sandbox for a group of processes. Newly spawned processes inherit the parent's environment.  Processes can only communicate inside the environment, and process ids are unique only inside the environment (and node).\r\n - processes are not resources anymore (kept in process state resources) and guests don't use a resource handle (opaque reference), but the actual process id (`u64`). Processes are identified by both node id (`u64`) and process id.\r\nWhen a lunatic node starts, it registers to a control node by sending the listen address, and authentication data. On successful registration, it receives a node id. Connections between nodes are lazy and established only when one node needs to communicate with another.\r\n\r\nDistributed API introduces new host functions:\r\n - `nodes_count` and `get_nodes` which currently return only a list of other node ids\r\n - `node_id` returns the current node id\r\n - `module_id` returns the global id assigned to a currently running Wasm module. This id is used when spawning on other nodes (they fetch modules from a control node). \r\n - `spawn` is similar to local spawn but also accepts a node id. It doesn't support linking currently\r\n - `send` and `send_receive_skip_search` also receive \r\nadditional node id parameter.\r\n  \r\nLunatic can also run in a non-distributed way as it does now.\r\n\r\nThe diagram below shows how process state depends on other distributed lunatic structures.\r\n\r\n<img src=\"https://user-images.githubusercontent.com/2822606/177097658-43c1c9ac-ca79-4740-8417-8f571c5424ed.svg\" alt=\"\" width=\"600\" />\r\n\r\n## Command Line Arguments\r\n\r\nCommand lines arguments were kept as in a previous version of the distributed:\r\n - `--node` sets the address and port for the node-to-node communication\r\n - `--control` sets the address of the control node\r\n - `--control-server` runs the control server bound to `--control` address\r\n - `--no-entry` run the node without a Wasm module\r\n\r\nHere is a small script that runs 4 nodes. The script assumes this repository is located in the `lunatic` directory and `lunatic-rs` contains the lunatic Rust library repository.\r\n\r\n```bash\r\n#!/bin/bash\r\nset -e\r\nSCRIPT=$(readlink -f \"$0\")\r\nBASEDIR=$(dirname \"$SCRIPT\")\r\n\r\nexport RUST_LOG=\"info\"\r\n\r\ncd $BASEDIR/lunatic\r\ncargo build --release\r\n\r\ncd $BASEDIR/lunatic-rs\r\ncargo build --release --examples\r\n\r\nprefix() {\r\n    # A helper to add prefix to each stdout/stderr line. It's useful to tell nodes apart\r\n    local prefix=\"$1\"\r\n    shift\r\n    \"$@\" > >(sed \"s/^/$prefix: /\") 2> >(sed \"s/^/$prefix: /\" >&2)\r\n}\r\n\r\nlunatic=$BASEDIR/lunatic/target/release/lunatic\r\n\r\nprefix \"A\" $lunatic --control 127.0.0.1:10410 --node 127.0.0.1:10001 --control-server --no-entry &\r\nprefix \"B\" $luantic --control 127.0.0.1:10410 --node 127.0.0.1:10002 --no-entry &\r\nprefix \"C\" $lunatic --control 127.0.0.1:10410 --node 127.0.0.1:10003 --no-entry &\r\nprefix \"D\" $lunatic --control 127.0.0.1:10410 --node 127.0.0.1:10004 \"$BASEDIR/lunatic-rs/target/wasm32-wasi/release/examples/distributed.wasm\"\r\n\r\nsleep 2\r\nkillall lunatic\r\n```\r\n\r\n## Other Updates\r\n\r\nThanks @kosticmarin we have also replaced `async-std` with `tokio` which resolves #94.\r\nHe has also worked on replacing plain TCP with QUIC. This should also be implemented soon.\r\n\r\n## Future Work\r\n\r\nHere are some things for the future: \r\n - currently distributed linking is not implemented and linking in general needs some refactoring\r\n - we are replacing plain TCP with QUIC which will give us streams and encryption\r\n - better errors in node-to-node communication\r\n - authentication\r\n - bandwith control with chunking and QUIC streams\r\n - node attributes (region, provider, etc.)\r\n - trusted, untrusted, and privelaged nodes\r\n - WASI for distributed, virtual FS", "reactions": {"url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/111/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/lunatic-solutions/lunatic/issues/111/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]