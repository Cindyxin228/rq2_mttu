[{"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/110", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/110/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/110/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/110/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/110", "id": 1058110770, "node_id": "PR_kwDODBSq4M4uwCgL", "number": 110, "title": "release ttrpc v0.5.2", "user": {"login": "Tim-Zhang", "id": 1013713, "node_id": "MDQ6VXNlcjEwMTM3MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1013713?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tim-Zhang", "html_url": "https://github.com/Tim-Zhang", "followers_url": "https://api.github.com/users/Tim-Zhang/followers", "following_url": "https://api.github.com/users/Tim-Zhang/following{/other_user}", "gists_url": "https://api.github.com/users/Tim-Zhang/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tim-Zhang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tim-Zhang/subscriptions", "organizations_url": "https://api.github.com/users/Tim-Zhang/orgs", "repos_url": "https://api.github.com/users/Tim-Zhang/repos", "events_url": "https://api.github.com/users/Tim-Zhang/events{/privacy}", "received_events_url": "https://api.github.com/users/Tim-Zhang/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2021-11-19T04:11:07Z", "updated_at": "2021-11-22T06:39:29Z", "closed_at": "2021-11-22T06:38:58Z", "author_association": "MEMBER", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/110", "html_url": "https://github.com/containerd/ttrpc-rust/pull/110", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/110.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/110.patch", "merged_at": "2021-11-22T06:38:58Z"}, "body": "Bump ttrpc version from 0.5.1 to 0.5.2\r\n\r\nSigned-off-by: Tim Zhang <tim@hyper.sh>", "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/110/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/110/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/107", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/107/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/107/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/107/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/107", "id": 1056889278, "node_id": "PR_kwDODBSq4M4usM_L", "number": 107, "title": "release: v0.4.16", "user": {"login": "Tim-Zhang", "id": 1013713, "node_id": "MDQ6VXNlcjEwMTM3MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1013713?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tim-Zhang", "html_url": "https://github.com/Tim-Zhang", "followers_url": "https://api.github.com/users/Tim-Zhang/followers", "following_url": "https://api.github.com/users/Tim-Zhang/following{/other_user}", "gists_url": "https://api.github.com/users/Tim-Zhang/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tim-Zhang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tim-Zhang/subscriptions", "organizations_url": "https://api.github.com/users/Tim-Zhang/orgs", "repos_url": "https://api.github.com/users/Tim-Zhang/repos", "events_url": "https://api.github.com/users/Tim-Zhang/events{/privacy}", "received_events_url": "https://api.github.com/users/Tim-Zhang/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-11-18T03:17:54Z", "updated_at": "2021-11-18T06:34:36Z", "closed_at": "2021-11-18T03:53:59Z", "author_association": "MEMBER", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/107", "html_url": "https://github.com/containerd/ttrpc-rust/pull/107", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/107.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/107.patch", "merged_at": "2021-11-18T03:53:58Z"}, "body": "Bump version from 0.4.15 to 0.4.16\r\n\r\nSigned-off-by: Tim Zhang <tim@hyper.sh>", "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/107/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/107/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/106", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/106/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/106/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/106/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/106", "id": 1056134088, "node_id": "PR_kwDODBSq4M4up3zf", "number": 106, "title": "Fix CI for branch 0.3.0", "user": {"login": "Tim-Zhang", "id": 1013713, "node_id": "MDQ6VXNlcjEwMTM3MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1013713?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tim-Zhang", "html_url": "https://github.com/Tim-Zhang", "followers_url": "https://api.github.com/users/Tim-Zhang/followers", "following_url": "https://api.github.com/users/Tim-Zhang/following{/other_user}", "gists_url": "https://api.github.com/users/Tim-Zhang/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tim-Zhang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tim-Zhang/subscriptions", "organizations_url": "https://api.github.com/users/Tim-Zhang/orgs", "repos_url": "https://api.github.com/users/Tim-Zhang/repos", "events_url": "https://api.github.com/users/Tim-Zhang/events{/privacy}", "received_events_url": "https://api.github.com/users/Tim-Zhang/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-11-17T13:29:59Z", "updated_at": "2021-11-20T11:22:33Z", "closed_at": "2021-11-18T02:59:21Z", "author_association": "MEMBER", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/106", "html_url": "https://github.com/containerd/ttrpc-rust/pull/106", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/106.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/106.patch", "merged_at": "2021-11-18T02:59:21Z"}, "body": "remove needless borrow.\r\n\r\nSigned-off-by: Tim Zhang <tim@hyper.sh>", "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/106/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/106/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/105", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/105/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/105/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/105/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/105", "id": 1056130485, "node_id": "PR_kwDODBSq4M4up3CN", "number": 105, "title": "Fix CI for branch 0.4.0", "user": {"login": "Tim-Zhang", "id": 1013713, "node_id": "MDQ6VXNlcjEwMTM3MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1013713?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Tim-Zhang", "html_url": "https://github.com/Tim-Zhang", "followers_url": "https://api.github.com/users/Tim-Zhang/followers", "following_url": "https://api.github.com/users/Tim-Zhang/following{/other_user}", "gists_url": "https://api.github.com/users/Tim-Zhang/gists{/gist_id}", "starred_url": "https://api.github.com/users/Tim-Zhang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Tim-Zhang/subscriptions", "organizations_url": "https://api.github.com/users/Tim-Zhang/orgs", "repos_url": "https://api.github.com/users/Tim-Zhang/repos", "events_url": "https://api.github.com/users/Tim-Zhang/events{/privacy}", "received_events_url": "https://api.github.com/users/Tim-Zhang/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2021-11-17T13:26:35Z", "updated_at": "2021-11-20T11:22:21Z", "closed_at": "2021-11-18T03:00:33Z", "author_association": "MEMBER", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/105", "html_url": "https://github.com/containerd/ttrpc-rust/pull/105", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/105.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/105.patch", "merged_at": "2021-11-18T03:00:33Z"}, "body": null, "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/105/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/105/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/104", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/104/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/104/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/104/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/104", "id": 1052956064, "node_id": "PR_kwDODBSq4M4uf17N", "number": 104, "title": "[release/0.4] sync/server: close conn fd in the reaper thread", "user": {"login": "fuweid", "id": 17510957, "node_id": "MDQ6VXNlcjE3NTEwOTU3", "avatar_url": "https://avatars.githubusercontent.com/u/17510957?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fuweid", "html_url": "https://github.com/fuweid", "followers_url": "https://api.github.com/users/fuweid/followers", "following_url": "https://api.github.com/users/fuweid/following{/other_user}", "gists_url": "https://api.github.com/users/fuweid/gists{/gist_id}", "starred_url": "https://api.github.com/users/fuweid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fuweid/subscriptions", "organizations_url": "https://api.github.com/users/fuweid/orgs", "repos_url": "https://api.github.com/users/fuweid/repos", "events_url": "https://api.github.com/users/fuweid/events{/privacy}", "received_events_url": "https://api.github.com/users/fuweid/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-11-14T14:40:30Z", "updated_at": "2021-11-18T03:57:34Z", "closed_at": "2021-11-18T03:11:46Z", "author_association": "MEMBER", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/104", "html_url": "https://github.com/containerd/ttrpc-rust/pull/104", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/104.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/104.patch", "merged_at": "2021-11-18T03:11:46Z"}, "body": "The sync/server uses accepted fd as key to maintain the connection and\r\ncloses the fd before client_handler thread exits. It will cause the\r\ndeadlock between listen and reaper threads. The timeline is like:\r\n\r\n```\r\nreaper\t\t\tlistener\t\t\tclient-handler-1\r\n\r\n\t\t\t\t\t\t\tclose(fd=100)\r\n\r\n\t\t\tfd(=100)=accepted\r\n\r\n\t\t\tstart client_handler-2\r\n\r\n\t\t\tlocked key-values\r\n\t\t\tupdate (100, client_handler-2)\r\n\t\t\tunlocked\r\n\r\n\t\t\t\t\t\t\tnotify reaper fd=100\r\n\r\nreceived fd=100\r\nlocked key-values\r\nwait-client_handler-2\r\n\t\t\t\t\t\t\texit(0)\r\n\r\n\t\t\tfd(=101)=accepted\r\n\t\t\tacquiring lock\r\n```\r\n\r\nThe lowest fd will be returned by accepted. The listener thread will use\r\nnew connection handler to replace the existing one. Since there is\r\nlong-running connection for container lifecycle, the reaper thread holds\r\nthe lock which listener thread is acquiring. It is deadlock.\r\n\r\nTo fix this issue, we should close fd in the reaper thread to prevent\r\nthe reuse fd.\r\n\r\nSigned-off-by: Wei Fu <fuweid89@gmail.com>\r\n(cherry picked from commit db3639c2669ceb29eee83c2954a97855f7243abb)\r\nSigned-off-by: Wei Fu <fuweid89@gmail.com>", "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/104/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/104/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/103", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/103/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/103/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/103/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/103", "id": 1051031534, "node_id": "PR_kwDODBSq4M4uaNFD", "number": 103, "title": "cargo: Update dependencies identified by audit", "user": {"login": "jodh-intel", "id": 20315601, "node_id": "MDQ6VXNlcjIwMzE1NjAx", "avatar_url": "https://avatars.githubusercontent.com/u/20315601?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jodh-intel", "html_url": "https://github.com/jodh-intel", "followers_url": "https://api.github.com/users/jodh-intel/followers", "following_url": "https://api.github.com/users/jodh-intel/following{/other_user}", "gists_url": "https://api.github.com/users/jodh-intel/gists{/gist_id}", "starred_url": "https://api.github.com/users/jodh-intel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jodh-intel/subscriptions", "organizations_url": "https://api.github.com/users/jodh-intel/orgs", "repos_url": "https://api.github.com/users/jodh-intel/repos", "events_url": "https://api.github.com/users/jodh-intel/events{/privacy}", "received_events_url": "https://api.github.com/users/jodh-intel/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2021-11-11T14:22:38Z", "updated_at": "2021-11-18T22:53:41Z", "closed_at": "2021-11-18T22:53:41Z", "author_association": "COLLABORATOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/103", "html_url": "https://github.com/containerd/ttrpc-rust/pull/103", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/103.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/103.patch", "merged_at": "2021-11-18T22:53:40Z"}, "body": "Ran `cargo audit fix` to update all crates with available security fixes.\r\n\r\nSigned-off-by: James O. D. Hunt <james.o.hunt@intel.com>", "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/103/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/103/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/102", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/102/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/102/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/102/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/102", "id": 1043758172, "node_id": "PR_kwDODBSq4M4uC4Bq", "number": 102, "title": "Support MacOS", "user": {"login": "mxpv", "id": 865334, "node_id": "MDQ6VXNlcjg2NTMzNA==", "avatar_url": "https://avatars.githubusercontent.com/u/865334?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mxpv", "html_url": "https://github.com/mxpv", "followers_url": "https://api.github.com/users/mxpv/followers", "following_url": "https://api.github.com/users/mxpv/following{/other_user}", "gists_url": "https://api.github.com/users/mxpv/gists{/gist_id}", "starred_url": "https://api.github.com/users/mxpv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mxpv/subscriptions", "organizations_url": "https://api.github.com/users/mxpv/orgs", "repos_url": "https://api.github.com/users/mxpv/repos", "events_url": "https://api.github.com/users/mxpv/events{/privacy}", "received_events_url": "https://api.github.com/users/mxpv/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-11-03T15:39:59Z", "updated_at": "2021-11-15T06:38:09Z", "closed_at": "2021-11-15T06:38:09Z", "author_association": "MEMBER", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/102", "html_url": "https://github.com/containerd/ttrpc-rust/pull/102", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/102.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/102.patch", "merged_at": "2021-11-15T06:38:09Z"}, "body": "This PR adds MacOS support to TTRPC rust crate.\r\n\r\nIt uses conditional compilation to exclude vsock on non Linux platforms.\r\nAnd another difference is that MacOS doesn't support creation of a descriptor with `CLOEXEC` atomically, so this PR adds `fcntl` calls after.\r\n\r\nclient/server example running on MacOS:\r\n\r\n<details>\r\n\r\n```\r\n   Compiling ttrpc-example v0.2.0 (/Users/mxpv/Github/ttrpc-rust/example)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 4.58s\r\n     Running `/Users/mxpv/Github/ttrpc-rust/target/debug/examples/server`\r\n[00:00:00.000] (10d15f600) INFO   server listen started\r\n[00:00:00.000] (10d15f600) INFO   server started\r\nServer is running, press Ctrl + C to exit\r\n[00:00:17.822] (700001891000) DEBUG  Got new client\r\n[00:00:17.822] (700001e9a000) TRACE  Got Message header MessageHeader { length: 91, stream_id: 1, type_: 1, flags: 0 }\r\n[00:00:17.822] (700001e9a000) TRACE  Got Message body [10, 17, 103, 114, 112, 99, 46, 65, 103, 101, 110, 116, 83, 101, 114, 118, 105, 99, 101, 18, 12, 79, 110, 108, 105, 110, 101, 67, 80, 85, 77, 101, 109, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 49, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 50, 42, 16, 10, 5, 107, 101, 121, 45, 50, 18, 7, 118, 97, 108, 117, 101, 45, 50]\r\n[00:00:17.822] (70000209d000) TRACE  Got Message header MessageHeader { length: 93, stream_id: 3, type_: 1, flags: 0 }\r\n[00:00:17.822] (700001e9a000) TRACE  Got Message request service: \"grpc.AgentService\" method: \"OnlineCPUMem\" metadata {key: \"key-1\" value: \"value-1-1\"} metadata {key: \"key-1\" value: \"value-1-2\"} metadata {key: \"key-2\" value: \"value-2\"}\r\n[00:00:17.823] (70000209d000) TRACE  Got Message body [10, 17, 103, 114, 112, 99, 46, 65, 103, 101, 110, 116, 83, 101, 114, 118, 105, 99, 101, 18, 14, 76, 105, 115, 116, 73, 110, 116, 101, 114, 102, 97, 99, 101, 115, 42, 16, 10, 5, 107, 101, 121, 45, 50, 18, 7, 118, 97, 108, 117, 101, 45, 50, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 49, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 50]\r\n[00:00:17.825] (700001c97000) TRACE  response thread get (MessageHeader { length: 54, stream_id: 1, type_: 2, flags: 0 }, [10, 52, 8, 5, 18, 48, 47, 103, 114, 112, 99, 46, 65, 103, 101, 110, 116, 83, 101, 114, 118, 105, 99, 101, 47, 79, 110, 108, 105, 110, 101, 67, 80, 85, 77, 101, 109, 32, 105, 115, 32, 110, 111, 116, 32, 115, 117, 112, 112, 111, 114, 116, 101, 100])\r\n[00:00:17.826] (7000022a0000) TRACE  Got Message header MessageHeader { length: 78, stream_id: 5, type_: 1, flags: 0 }\r\n[00:00:17.826] (70000209d000) TRACE  Got Message request service: \"grpc.AgentService\" method: \"ListInterfaces\" metadata {key: \"key-2\" value: \"value-2\"} metadata {key: \"key-1\" value: \"value-1-1\"} metadata {key: \"key-1\" value: \"value-1-2\"}\r\n[00:00:17.826] (7000022a0000) TRACE  Got Message body [10, 11, 103, 114, 112, 99, 46, 72, 101, 97, 108, 116, 104, 18, 5, 67, 104, 101, 99, 107, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 49, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 50, 42, 16, 10, 5, 107, 101, 121, 45, 50, 18, 7, 118, 97, 108, 117, 101, 45, 50]\r\n[00:00:17.826] (700001c97000) TRACE  response thread get (MessageHeader { length: 23, stream_id: 3, type_: 2, flags: 0 }, [10, 0, 18, 19, 10, 7, 18, 5, 102, 105, 114, 115, 116, 10, 8, 18, 6, 115, 101, 99, 111, 110, 100])\r\n[00:00:17.826] (7000022a0000) TRACE  Got Message request service: \"grpc.Health\" method: \"Check\" metadata {key: \"key-1\" value: \"value-1-1\"} metadata {key: \"key-1\" value: \"value-1-2\"} metadata {key: \"key-2\" value: \"value-2\"}\r\n[00:00:17.826] (700001c97000) TRACE  response thread get (MessageHeader { length: 18, stream_id: 5, type_: 2, flags: 0 }, [10, 16, 8, 5, 18, 12, 74, 117, 115, 116, 32, 102, 111, 114, 32, 102, 117, 110])\r\n[00:00:19.828] (700001e9a000) TRACE  Got Message header MessageHeader { length: 80, stream_id: 7, type_: 1, flags: 0 }\r\n[00:00:19.828] (700001e9a000) TRACE  Got Message body [10, 11, 103, 114, 112, 99, 46, 72, 101, 97, 108, 116, 104, 18, 7, 86, 101, 114, 115, 105, 111, 110, 42, 16, 10, 5, 107, 101, 121, 45, 50, 18, 7, 118, 97, 108, 117, 101, 45, 50, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 49, 42, 18, 10, 5, 107, 101, 121, 45, 49, 18, 9, 118, 97, 108, 117, 101, 45, 49, 45, 50]\r\n[00:00:19.828] (700001e9a000) TRACE  Got Message request service: \"grpc.Health\" method: \"Version\" metadata {key: \"key-2\" value: \"value-2\"} metadata {key: \"key-1\" value: \"value-1-1\"} metadata {key: \"key-1\" value: \"value-1-2\"}\r\n[00:00:19.828] (700001e9a000) INFO   version\r\n[00:00:19.828] (700001e9a000) INFO   ctx TtrpcContext { fd: 8, mh: MessageHeader { length: 80, stream_id: 7, type_: 1, flags: 0 }, res_tx: Sender { .. }, metadata: {\"key-1\": [\"value-1-1\", \"value-1-2\"], \"key-2\": [\"value-2\"]}, timeout_nano: 0 }\r\n[00:00:19.828] (700001c97000) TRACE  response thread get (MessageHeader { length: 21, stream_id: 7, type_: 2, flags: 0 }, [10, 0, 18, 17, 10, 5, 48, 46, 48, 46, 49, 18, 8, 109, 111, 99, 107, 46, 48, 46, 49])\r\n[00:00:19.836] (70000209d000) TRACE  Socket error socket disconnected\r\n[00:00:19.836] (70000209d000) TRACE  Socket error send control_tx\r\n[00:00:19.836] (7000022a0000) DEBUG  Failed to send SendError { .. }\r\n[00:00:19.836] (700001e9a000) DEBUG  Failed to send SendError { .. }\r\n[00:00:19.836] (700001c97000) TRACE  response thread quit\r\n[00:00:19.836] (700001891000) DEBUG  client thread quit\r\n\r\n\r\n   Compiling ttrpc-example v0.2.0 (/Users/mxpv/Github/ttrpc-rust/example)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 2.62s\r\n     Running `/Users/mxpv/Github/ttrpc-rust/target/debug/examples/client`\r\nMain OS Thread - agent.online_cpu_mem() started: 27.313\u00b5s\r\nOS Thread ThreadId(4) - health.check() started: 47.316\u00b5s\r\nOS Thread ThreadId(5) - agent.list_interfaces() started: 67.736\u00b5s\r\nMain OS Thread - agent.online_cpu_mem() -> RpcStatus(code: NOT_FOUND message: \"/grpc.AgentService/OnlineCPUMem is not supported\") ended: 4.485696ms\r\n\r\nsleep 2 seconds ...\r\n\r\nOS Thread ThreadId(4) - health.check() -> Err(RpcStatus(code: NOT_FOUND message: \"Just for fun\")) ended: 4.629423ms\r\nOS Thread ThreadId(5) - agent.list_interfaces() -> Interfaces {name: \"first\"} Interfaces {name: \"second\"} ended: 5.419261ms\r\nMain OS Thread - health.version() started: 2.005767967s\r\nMain OS Thread - health.version() -> Ok(grpc_version: \"0.0.1\" agent_version: \"mock.0.1\") ended: 2.014094586s\r\n```\r\n\r\n</details>\r\n\r\nSigned-off-by: Maksym Pavlenko <pavlenko.maksym@gmail.com>", "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/102/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/102/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}, {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/101", "repository_url": "https://api.github.com/repos/containerd/ttrpc-rust", "labels_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/101/labels{/name}", "comments_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/101/comments", "events_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/101/events", "html_url": "https://github.com/containerd/ttrpc-rust/pull/101", "id": 1040528024, "node_id": "PR_kwDODBSq4M4t5N8l", "number": 101, "title": "sync/server: close conn fd in the reaper thread", "user": {"login": "fuweid", "id": 17510957, "node_id": "MDQ6VXNlcjE3NTEwOTU3", "avatar_url": "https://avatars.githubusercontent.com/u/17510957?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fuweid", "html_url": "https://github.com/fuweid", "followers_url": "https://api.github.com/users/fuweid/followers", "following_url": "https://api.github.com/users/fuweid/following{/other_user}", "gists_url": "https://api.github.com/users/fuweid/gists{/gist_id}", "starred_url": "https://api.github.com/users/fuweid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fuweid/subscriptions", "organizations_url": "https://api.github.com/users/fuweid/orgs", "repos_url": "https://api.github.com/users/fuweid/repos", "events_url": "https://api.github.com/users/fuweid/events{/privacy}", "received_events_url": "https://api.github.com/users/fuweid/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-10-31T17:02:49Z", "updated_at": "2021-11-04T08:43:37Z", "closed_at": "2021-11-04T08:35:51Z", "author_association": "MEMBER", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/pulls/101", "html_url": "https://github.com/containerd/ttrpc-rust/pull/101", "diff_url": "https://github.com/containerd/ttrpc-rust/pull/101.diff", "patch_url": "https://github.com/containerd/ttrpc-rust/pull/101.patch", "merged_at": "2021-11-04T08:35:51Z"}, "body": "The sync/server uses accepted fd as key to maintain the connection and\r\ncloses the fd before client_handler thread exits. It will cause the\r\ndeadlock between listen and reaper threads. The timeline is like:\r\n\r\n```\r\nreaper\t\t\tlistener\t\t\tclient-handler-1\r\n\r\n\t\t\t\t\t\t\tclose(fd=100)\r\n\r\n\t\t\tfd(=100)=accepted\r\n\r\n\t\t\tstart client_handler-2\r\n\r\n\t\t\tlocked key-values\r\n\t\t\tupdate (100, client_handler-2)\r\n\t\t\tunlocked\r\n\r\n\t\t\t\t\t\t\tnotify reaper fd=100\r\n\r\nreceived fd=100\r\nlocked key-values\r\nwait-client_handler-2\r\n\t\t\t\t\t\t\texit(0)\r\n\r\n\t\t\tfd(=101)=accepted\r\n\t\t\tacquiring lock\r\n```\r\n\r\nThe lowest fd will be returned by accepted. The listener thread will use\r\nnew connection handler to replace the existing one. Since there is\r\nlong-running connection for container lifecycle, the reaper thread holds\r\nthe lock which listener thread is acquiring. It is deadlock.\r\n\r\nTo fix this issue, we should close fd in the reaper thread to prevent\r\nthe reuse fd.\r\n\r\nSigned-off-by: Wei Fu <fuweid89@gmail.com>", "reactions": {"url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/101/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/containerd/ttrpc-rust/issues/101/timeline", "performed_via_github_app": null, "state_reason": null, "score": 1.0}]